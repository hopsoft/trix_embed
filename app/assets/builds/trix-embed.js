/*
  trix-embed 0.0.2 (MIT)
  Copyright Â© 2023 Nate Hopkins (hopsoft) <natehop@gmail.com>
*/
var Y=Object.defineProperty,Z=Object.defineProperties;var ee=Object.getOwnPropertyDescriptors;var K=Object.getOwnPropertySymbols;var te=Object.prototype.hasOwnProperty,re=Object.prototype.propertyIsEnumerable;var U=(n,e,t)=>e in n?Y(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,R=(n,e)=>{for(var t in e||(e={}))te.call(e,t)&&U(n,t,e[t]);if(K)for(var t of K(e))re.call(e,t)&&U(n,t,e[t]);return n},C=(n,e)=>Z(n,ee(e));var S=(n,e,t)=>(U(n,typeof e!="symbol"?e+"":e,t),t);var A={name:"AES-GCM",length:256},ie=!0,ne=["encrypt","decrypt"];async function oe(){let e=["encrypt","decrypt"];return await crypto.subtle.generateKey(A,!0,e)}async function se(n){let e=await crypto.subtle.exportKey("jwk",n);return JSON.stringify(e)}async function q(n){let e=JSON.parse(n);return await crypto.subtle.importKey("jwk",e,A,ie,ne)}async function ae(n,e){let t=new TextEncoder().encode(String(n)),r=crypto.getRandomValues(new Uint8Array(12)),i=await crypto.subtle.encrypt(C(R({},A),{iv:r}),e,t),o={ciphertext:btoa(String.fromCharCode(...new Uint8Array(i))),iv:btoa(String.fromCharCode(...r))};return btoa(JSON.stringify(o))}async function le(n,e){let t=JSON.parse(atob(n)),r=new Uint8Array(atob(t.ciphertext).split("").map(s=>s.charCodeAt(0))),i=new Uint8Array(atob(t.iv).split("").map(s=>s.charCodeAt(0))),o=await crypto.subtle.decrypt(C(R({},A),{iv:i}),e,r);return new TextDecoder().decode(o)}async function v(){let n=await oe(),e=await se(n);return btoa(e)}async function x(n,e=[]){let t=await q(atob(n));return Promise.all(e.map(r=>ae(r,t)))}async function V(n,e=[]){let t=await q(atob(n));return Promise.all(e.map(r=>le(r,t)))}async function I(n=[]){let e=await v(),t=await x(e,n);return console.log(`data-trix-embed-key-value="${e}"`),console.log(`data-trix-embed-hosts-value='${JSON.stringify(t)}'`),{key:e,encryptedValues:t}}function g(n,e=t=>{}){try{let t=new URL(String(n).trim());return t&&e&&e(t),t}catch(t){console.info(`Failed to parse URL! value='${n}']`)}return null}function z(n,e=t=>{}){var r;let t=(r=g(n))==null?void 0:r.host;return t&&e&&e(t),t}function N(n){return document.createTreeWalker(n,NodeFilter.SHOW_TEXT,e=>e.nodeValue.match(/http/gi)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP)}function ce(n){let e=new Set,t=N(n),r;for(;r=t.nextNode();)r.nodeValue.split(/\s+/).filter(i=>i.startsWith("http")).forEach(i=>g(i,o=>e.add(o.href)));return[...e]}function k(n){if(n.src){let e=n.src.trim();if(e.length)return e}if(n.href){let e=n.href.trim();if(e.length)return e}return""}function de(n){let e=new Set;return n.src&&g(n.src,r=>e.add(r.href)),n.href&&g(n.href,r=>e.add(r.href)),n.querySelectorAll("[src], [href]").forEach(r=>g(k(r),i=>e.add(i.href))),[...e]}function M(n,e=[]){let t=z(n);return t?!!e.find(r=>t.includes(r)):!1}function F(n){return[...n.reduce((e,t)=>(z(t,r=>e.add(r)),e),new Set)]}function D(n){let e=de(n),t=ce(n);return[...new Set([...e,...t])]}var W={avif:"image/avif",bmp:"image/bmp",gif:"image/gif",heic:"image/heic",heif:"image/heif",ico:"image/x-icon",jp2:"image/jp2",jpeg:"image/jpeg",jpg:"image/jpeg",jxr:"image/vnd.ms-photo",png:"image/png",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",webp:"image/webp"};var me=W,ue=["animate","animateMotion","animateTransform","area","audio","base","embed","feDisplacementMap","feImage","feTile","filter","font-face-uri","iframe","image","link","object","script","source","track","use","video"],he=["audio","embed","iframe","img","input","script","source","track","video","frame","frameset","object","picture","use"],J=ue.concat(he);function _(n){return!!Object.values(W).find(e=>e===H(n))}function H(n){let e;if(e=g(n),!e)return null;let t=e.pathname.lastIndexOf(".");if(!t)return null;let r=e.pathname.substring(t+1);return me[r]}var $={},E=class{constructor(e){S(this,"protectSubmit",e=>{let t=this.controller.formElement,r=e.target.closest("form");r&&r.action===t.action&&r.method===t.method&&r!==t&&e.preventDefault()});this.controller=e}preventAttachments(){var e;(e=this.controller.toolbarElement.querySelector('[data-trix-button-group="file-tools"]'))==null||e.remove(),this.controller.element.removeAttribute("data-direct-upload-url"),this.controller.element.removeAttribute("data-blob-url-template"),this.controller.element.addEventListener("trix-file-accept",t=>t.preventDefault())}preventLinks(){var e;(e=this.controller.toolbarElement.querySelector('[data-trix-action="link"]'))==null||e.remove()}protect(){if(this.preventAttachments(),this.preventLinks(),!this.controller.formElement)return;let e=this.controller.formElement,t=this.controller.inputElement,r=`${e.method}${e.action}`;document.removeEventListener("submit",$[r],!0),$[r]=this.protectSubmit.bind(this),document.addEventListener("submit",$[r],!0),new MutationObserver((o,s)=>{o.forEach(m=>{let{addedNodes:h,target:p,type:u}=m;switch(u){case"attributes":let a=node.closest("form");e!=null&&e.action&&e.action===(a==null?void 0:a.action)&&(p.id===t.id||p.name===t.name)&&p.remove();break;case"childList":h.forEach(l=>{if(l.nodeType===Node.ELEMENT_NODE){let d=l.closest("form");e!=null&&e.action&&e.action===(d==null?void 0:d.action)?d!==e&&l.remove():t!=null&&t.name&&t.name===(l==null?void 0:l.name)&&l.remove()}});break}})}).observe(document.body,{attributeFilter:["id","name"],attributes:!0,childList:!0,subtree:!0})}cleanup(){let e=this.controller.element,t=this.controller.inputElement,r=this.controller.toolbarElement;t==null||t.remove(),r==null||r.remove(),e==null||e.remove()}};var w=class{constructor(e){var t;this.controller=e,this.base=this.obfuscate([location.pathname,(t=this.controller.element.closest("[id]"))==null?void 0:t.id].join("/"))}split(e){let t=Math.ceil(e.length/2);return[e.slice(0,t),e.slice(t)]}obfuscate(e){var i;let t=[...e].map(o=>o.charCodeAt(0));return[(i=this.split(t)[1])==null?void 0:i.reverse(),t[0]].flat().join("")}read(e){return sessionStorage.getItem(this.generateStorageKey(e))}write(e,t){return sessionStorage.setItem(this.generateStorageKey(e),t)}remove(e){return sessionStorage.removeItem(this.generateStorageKey(e))}generateStorageKey(e){let t=[...this.obfuscate(e)],[r,i]=this.split(t);return btoa(`${r}/${this.base}/${i}`)}};var pe={header:"<div><h1></h1><hr></div>",iframe:"<div><iframe></iframe></div>",image:"<div><img></img></div>",error:`
    <div>
      <h1>Copy/Paste Info</h1>
      <hr>
      <h3>The pasted content includes media from unsupported hosts.</h3>
      <h2>Prohibited Hosts</h2>
      <ul data-list="prohibited-hosts">
        <li>Media is only supported from allowed hosts.</li>
      </ul>
      <h2>Allowed Hosts</h2>
      <ul data-list="allowed-hosts">
        <li>Allowed hosts not configured.</li>
      </ul>
    </div>
  `,exception:`
    <div style='background-color:lightyellow; color:red; border:solid 1px red; padding:20px;'>
      <h1>Unhandled Exception!</h1>
      <p>Show a programmer the message below.</p>
      <pre style="background-color:darkslategray; color:whitesmoke; padding:10px;"><code></code></pre>
    </div>
  `};function B(n){let e=document.createElement("template");return e.innerHTML=pe[n],e}var fe="a abbr acronym action-text-attachment address b big blockquote br cite code dd del dfn div dl dt em figcaption figure h1 h2 h3 h4 h5 h6 hr i iframe img ins kbd li ol p pre samp small span strong sub sup time tt ul var".split(" "),ge="abbr allow allowfullscreen allowpaymentrequest alt caption cite content-type credentialless csp datetime filename filesize height href lang loading name presentation previewable referrerpolicy sandbox sgid src srcdoc title url width xml:lang".split(" "),T=class{constructor(e){this.controller=e,this.initializeTempates()}sanitize(e){return[e].concat([...e.querySelectorAll("*")]).forEach(r=>{fe.includes(r.tagName.toLowerCase())?[...r.attributes].forEach(i=>{ge.includes(i.name.toLowerCase())||r.removeAttribute(i.name)}):r.remove()}),e}initializeTempates(){["error","exception","header","iframe","image"].forEach(t=>this.initializeTemplate(t))}initializeTemplate(e){let t,r=`${e}Template`,i=`${r}Value`;this.controller[`has${i.charAt(0).toUpperCase()+i.slice(1)}`]&&(t=document.getElementById(this.controller[i])),this[r]=t||B(e),this.controller[i]=null}renderHeader(e){let t=this.headerTemplate.content.firstElementChild.cloneNode(!0),r=t.tagName.match(/h1/i)?t:t.querySelector("h1");return r.innerHTML=e,t.outerHTML}renderURLs(e=["https://example.com","https://test.com"]){if(e=e.filter(t=>g(t)).sort(),!!e.length)return`<ul>${e.map(t=>`<li>${t}</li>`).join("")}</ul><br>`}renderLinks(e=["https://example.com","https://test.com"]){return e=e.filter(r=>g(r)).sort(),e.length?`<ul>${e.map(r=>`<li><a href='${r}'>${r}</a></li>`).join("")}</ul><br>`:void 0}renderEmbed(e="https://example.com"){let t;if(_(e)){t=this.imageTemplate.content.firstElementChild.cloneNode(!0);let r=t.tagName.match(/img/i)?t:t.querySelector("img");r.src=e}else{t=this.iframeTemplate.content.firstElementChild.cloneNode(!0);let r=t.tagName.match(/iframe/i)?t:t.querySelector("iframe");r.src=e}return this.sanitize(t).outerHTML}renderEmbeds(e=["https://example.com","https://test.com"]){if(e!=null&&e.length)return e.map(t=>this.renderEmbed(t))}renderErrors(e=["https://example.com","https://test.com"],t=[]){if(!(e!=null&&e.length))return;let r=this.errorTemplate.content.firstElementChild.cloneNode(!0),i=r.querySelector('[data-list="prohibited-hosts"]'),o=r.querySelector('[data-list="allowed-hosts"]');if(i){let s=F(e).sort();s.length&&(i.innerHTML=s.map(m=>`<li>${m}</li>`).join(""))}return o&&t.length&&(o.innerHTML=t.map(s=>`<li>${s}</li>`).join("")),r.outerHTML}renderException(e){let t=this.exceptionTemplate.content.firstElementChild.cloneNode(!0),r=t.querySelector("code");return r.innerHTML=e.message,t.outerHTML}};var be={Controller:null,Trix:null};function G(n=be){var r;let{Controller:e,Trix:t}=n;return r=class extends e{async connect(){this.guard=new E(this),this.paranoidValue&&this.guard.protect(),this.store=new w(this),await this.rememberConfig(),this.onpaste=this.paste.bind(this),this.element.addEventListener("trix-paste",this.onpaste,!0),window.addEventListener("beforeunload",()=>this.disconnect())}disconnect(){this.element.removeEventListener("trix-paste",this.onpaste,!0),this.paranoid&&this.guard.cleanup(),this.forgetConfig()}async paste(i){let{html:o,string:s,range:m}=i.paste,h=o||s||"",p=this.createTemplate(h),u=p.content.firstElementChild,a=D(u);if(!a.length)return;i.preventDefault(),this.editor.setSelectedRange(m);let l=await this.hosts,d=new T(this);try{let c=new Set(a.filter(f=>H(f)));[...p.content.firstElementChild.querySelectorAll("iframe")].forEach(f=>c.add(f.src)),c=[...c];let b=c.filter(f=>M(f,l)),Q=c.filter(f=>!b.includes(f)),j=a.filter(f=>!c.includes(f)),O=j.filter(f=>M(f,l)),ve=j.filter(f=>!O.includes(f)),y;if(y=Q,y.length&&await this.insert(d.renderErrors(y,l.sort())),y=b,y.length&&await this.insert(d.renderEmbeds(y)),a.length===1&&b.length===1)return;let P=this.sanitizePastedElement(u,{validMediaURLs:b,validStandardURLs:O}).innerHTML.trim();P.length&&this.insert(P,{disposition:"inline"})}catch(c){this.insert(d.renderException(c))}}createTemplate(i){let o=document.createElement("template");return o.innerHTML=`<div>${i.trim()}</div>`,o}extractLabelFromElement(i,o={default:null}){let s=i.title;return s&&s.length||(s=i.textContent.trim(),s&&s.length)?s:o.default}sanitizePastedElement(i,o={validMediaURLs:[],validStandardURLs:[]}){let{validMediaURLs:s,validStandardURLs:m}=o;i=i.cloneNode(!0),i.querySelectorAll(J.join(", ")).forEach(a=>{let l=k(a),d=this.extractLabelFromElement(a,{default:l}),c=s.includes(l)?`<ins allow="true" caption="Allowed Embed">${d}</ins>`:`<del allow="false" caption="Prohibited Embed">${d}</del>`;a.outerHTML=c}),i.querySelectorAll("a").forEach(a=>{let l=k(a),d=this.extractLabelFromElement(a,{default:l}),c=m.includes(l)?`<a allow="true" caption="Allowed Link" href="${l}">${d}</a>`:`<del allow="false" caption="Prohibited Link: ${l}">${d}</del>`;a.outerHTML=c});let h=N(i),p=[],u;for(;u=h.nextNode();)u.replacements=u.replacements||new Set,p.push(u),u.nodeValue.split(/\s+/).filter(d=>d.startsWith("http")).forEach(d=>{var b;let c=(b=g(d))==null?void 0:b.href,L=m.includes(c)||m.includes(c)?`<a allow="true" caption="Allowed Link" href="${c}">${c}</a><br>`:`<del allow="false" caption="Prohibited Link">${c}</del><br>`;u.replacements.add({match:d,replacement:L})});return p.forEach(a=>{if(!a.replacements.size)return;let l=a.nodeValue;[...a.replacements].sort((c,L)=>L.match.length-c.match.length).forEach(c=>l=l.replaceAll(c.match,c.replacement)),a.replaceWith(this.createTemplate(l).content.firstElementChild)}),i.innerHTML.replaceAll(/(\n|\r|\f|\v)+/g,"<br>"),i}insertAttachment(i,o={delay:0}){let{delay:s}=o;return new Promise(m=>{setTimeout(()=>{let h=new t.Attachment({content:i,contentType:"application/vnd.trix-embed"});this.editor.insertAttachment(h),m()},s)})}insertHTML(i,o={delay:0}){let{delay:s}=o;return new Promise(m=>{setTimeout(()=>{this.editor.insertHTML(i),this.editor.moveCursorInDirection("forward"),this.editor.insertLineBreak(),this.editor.moveCursorInDirection("backward"),m()},s)})}insert(i,o={delay:0,disposition:"attachment"}){let{delay:s,disposition:m}=o;return i!=null&&i.length?new Promise(h=>{setTimeout(()=>{if(typeof i=="string")return m==="inline"?this.insertHTML(i,{delay:s}).then(h):this.insertAttachment(i,{delay:s}).then(h);if(Array.isArray(i))return m==="inline"?i.reduce((p,u,a)=>p.then(this.insertHTML(u,{delay:s})),Promise.resolve()).then(h):i.reduce((p,u,a)=>p.then(this.insertAttachment(u,{delay:s})),Promise.resolve()).then(h);h()})}):Promise.resolve()}get editor(){return this.element.editor}get toolbarElement(){let i=this.element.previousElementSibling;return i!=null&&i.tagName.match(/trix-toolbar/i)?i:null}get inputElement(){var i;return((i=this.formElement)==null?void 0:i.querySelector(`#${this.element.getAttribute("input")}`))||document.getElementById(this.element.getAttribute("input"))}get formElement(){return this.element.closest("form")}get paranoid(){return!!this.store.read("paranoid")}get key(){try{return JSON.parse(this.store.read("key"))[2]}catch(i){}}get hosts(){try{return V(this.key,JSON.parse(this.store.read("hosts")))}catch(i){return[]}}get reservedDomains(){return["example.com","test.com","invalid.com","example.cat","nic.example","example.co.uk"]}async rememberConfig(){let i=await v(),o=await x(i,this.reservedDomains),s=await x(i,this.hostsValue);this.store.write("key",JSON.stringify([o[0],o[1],i,o[2]])),this.element.removeAttribute("data-trix-embed-key-value"),this.store.write("hosts",JSON.stringify(s)),this.element.removeAttribute("data-trix-embed-hosts-value"),this.paranoidValue!==!1&&(this.store.write("paranoid",JSON.stringify(o.slice(3))),this.element.removeAttribute("data-trix-embed-paranoid"))}forgetConfig(){this.store.remove("key"),this.store.remove("hosts"),this.store.remove("paranoid")}},S(r,"values",{validTemplate:String,errorTemplate:String,headerTemplate:String,iframeTemplate:String,imageTemplate:String,hosts:Array,paranoid:{type:Boolean,default:!0}}),r}var X=!1,ye={application:null,Controller:null,Trix:null};function xe(n=ye){if(X)return;let{application:e,Controller:t,Trix:r}=n;e.register("trix-embed",G({Controller:t,Trix:r})),X=!0}self.TrixEmbed={initialize:xe,generateKey:v,encryptValues:x,generateKeyAndEncryptValues:I};var Be=self.TrixEmbed;export{Be as default};
