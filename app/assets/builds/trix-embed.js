/*
  trix-embed 0.0.2 (MIT)
  Copyright Â© 2023 Nate Hopkins (hopsoft) <natehop@gmail.com>
*/
var be=Object.defineProperty,ye=Object.defineProperties;var xe=Object.getOwnPropertyDescriptors;var J=Object.getOwnPropertySymbols;var we=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var O=(t,e,r)=>e in t?be(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,E=(t,e)=>{for(var r in e||(e={}))we.call(e,r)&&O(t,r,e[r]);if(J)for(var r of J(e))ve.call(e,r)&&O(t,r,e[r]);return t},L=(t,e)=>ye(t,xe(e));var _=(t,e,r)=>(O(t,typeof e!="symbol"?e+"":e,r),r);var B={version:"0.0.2"};var U={name:"AES-GCM",length:256},Ee=!0,Le=["encrypt","decrypt"];async function Te(){let e=["encrypt","decrypt"];return await crypto.subtle.generateKey(U,!0,e)}async function Se(t){let e=await crypto.subtle.exportKey("jwk",t);return JSON.stringify(e)}async function G(t){let e=JSON.parse(t);return await crypto.subtle.importKey("jwk",e,U,Ee,Le)}async function Ae(t,e){let r=new TextEncoder().encode(String(t)),n=crypto.getRandomValues(new Uint8Array(12)),i=await crypto.subtle.encrypt(L(E({},U),{iv:n}),e,r),a={ciphertext:btoa(String.fromCharCode(...new Uint8Array(i))),iv:btoa(String.fromCharCode(...n))};return btoa(JSON.stringify(a))}async function ke(t,e){let r=JSON.parse(atob(t)),n=new Uint8Array(atob(r.ciphertext).split("").map(s=>s.charCodeAt(0))),i=new Uint8Array(atob(r.iv).split("").map(s=>s.charCodeAt(0))),a=await crypto.subtle.decrypt(L(E({},U),{iv:i}),e,n);return new TextDecoder().decode(a)}async function T(){let t=await Te(),e=await Se(t);return btoa(e)}async function y(t,e=[]){let r=await G(atob(t));return Promise.all(e.map(n=>Ae(n,r)))}async function X(t,e=[]){let r=await G(atob(t));return Promise.all(e.map(n=>ke(n,r)))}async function Q(t=[]){let e=await T(),r=await y(e,t);return console.log(`data-trix-embed-key-value="${e}"`),console.log(`data-trix-embed-hosts-value='${JSON.stringify(r)}'`),{key:e,encryptedValues:r}}var Y=t=>Math.floor(Math.random()*t),w=(t,e=null)=>{let r=[...t];e==="all"&&(e=r.length);let n=r.length,i=[],a=new Set;for(;i.length<e;){let s=Y(n);for(;a.has(s);)s=Y(n);a.add(s),i.push(r[s])}return typeof e=="number"?i:i[0]};function x(t,e=r=>{}){try{let r=new URL(String(t).trim());return r&&e&&e(r),r}catch(r){console.info(`Failed to parse URL! value='${t}']`)}return null}function Z(t,e=r=>{}){var n;let r=(n=x(t))==null?void 0:n.host;return r&&e&&e(r),r}function N(t){return document.createTreeWalker(t,NodeFilter.SHOW_TEXT,e=>e.nodeValue.match(/http/gi)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP)}function Re(t){let e=new Set,r=N(t),n;for(;n=r.nextNode();)n.nodeValue.split(/\s+/).filter(i=>i.startsWith("http")).forEach(i=>x(i,a=>e.add(a.href)));return[...e]}function M(t){if(t.src){let e=t.src.trim();if(e.length)return e}if(t.href){let e=t.href.trim();if(e.length)return e}return""}function Ue(t){let e=new Set;return t.src&&x(t.src,n=>e.add(n.href)),t.href&&x(t.href,n=>e.add(n.href)),t.querySelectorAll("[src], [href]").forEach(n=>x(M(n),i=>e.add(i.href))),[...e]}function j(t,e=[],r=[]){let n=Z(t);return r.includes("*")||r.find(i=>n.endsWith(i))?!1:!!(e.find(i=>n.endsWith(i))||e.includes("*")&&(n||t.startsWith("data:")||t.startsWith("news:")||t.startsWith("tel:")))}function ee(t){return[...t.reduce((e,r)=>(Z(r,n=>e.add(n)),e),new Set)]}function te(t){let e=Ue(t),r=Re(t);return[...new Set([...e,...r])]}var re={attachment:"trix-embed/attachment"};var ie={avif:"image/avif",bmp:"image/bmp",gif:"image/gif",heic:"image/heic",heif:"image/heif",ico:"image/x-icon",jp2:"image/jp2",jpeg:"image/jpeg",jpg:"image/jpeg",jxr:"image/vnd.ms-photo",png:"image/png",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",webp:"image/webp"};var Me=ie,Ce=["animate","animateMotion","animateTransform","area","audio","base","embed","feDisplacementMap","feImage","feTile","filter","font-face-uri","iframe","image","link","object","script","source","track","use","video"],Oe=["audio","embed","iframe","img","input","script","source","track","video","frame","frameset","object","picture","use"],ne="trix-editor",ae="action-text-attachment",se=Ce.concat(Oe);function oe(t){return!!Object.values(ie).find(e=>e===H(t))}function H(t){let e;if(e=x(t),!e)return null;let r=e.pathname.lastIndexOf(".");if(!r)return null;let n=e.pathname.substring(r+1);return Me[n]}var le,P,D={},S={add:"trix-embed:form:add",create:"trix-embed:form:create"};function de(t){return`${t==null?void 0:t.method}:${t==null?void 0:t.action}`.trim().toLowerCase()}function me(t){if(!t)return;let e=t.closest(ne),r=e?t.querySelector(`#${e.getAttribute("input")}`):{};t.protectedInput={id:r.id,name:r.name};let n=de(t);D[n]=D[n]||new Set,D[n].add(t)}function Ne(t){let e=de(t),r=[...r[e]],n=r.find(i=>i===t);if(!r.length)return!0;if(n!=null&&n.pasting)return!1;if(n)return!0;r.map(i=>i.protectedInput).forEach(i=>!(i&&(i.name&&t.querySlector(`[name="${i.name}"]`)||i.id&&t.querySlector(`#${i.id}`))))}function ce(t){Ne(t.target)||t.preventDefault()}function V(t){t.removeEventListener("submit",ce,!0),t.addEventListener("submit",ce,!0)}function ue(t,e){document.dispatchEvent(new CustomEvent(t,{bubbles:!1,cancelable:!1,detail:{form:e}}))}function je(){if(le)return;le=!0;let t=Document.prototype.createElement;Object.defineProperty(Document.prototype,"createElement",{value:function(){let e=t.apply(this,arguments);try{String(arguments[0]).toUpperCase()==="FORM"&&ue(S.form.create,e)}catch(r){console.error(`Error during ${S.formCreate}`,r)}return e},configurable:!1})}function He(){P||(P=new MutationObserver(t=>t.forEach(e=>e.addedNodes.forEach(r=>{r instanceof HTMLFormElement&&ue(S.form.add,element)}))),P.observe(document.body,{childList:!0,subtree:!0}))}je();He();document.addEventListener(S.add,t=>V(t.target),!0);document.addEventListener(S.create,t=>V(t.target),!0);document.querySelectorAll("form").forEach(t=>V(t));var A=class{constructor(e){this.controller=e}preventAttachments(){var e,r,n,i,a;(e=this.editor)==null||e.removeAttribute("data-direct-upload-url"),(r=this.editor)==null||r.removeAttribute("data-blob-url-template"),(n=this.editor)==null||n.addEventListener("trix-file-accept",s=>s.preventDefault(),!0),(a=(i=this.toolbar)==null?void 0:i.querySelector('[data-trix-button-group="file-tools"]'))==null||a.remove()}async preventLinks(){var n,i;let e=await this.controller.allowedLinkHosts;!(await this.controller.blockedLinkHosts).length&&e.includes("*")||(i=(n=this.toolbar)==null?void 0:n.querySelector('[data-trix-action="link"]'))==null||i.remove()}protect(e=0){if(!this.toolbar&&e<10)return setTimeout(()=>this.protect(e+1),25);this.preventAttachments(),this.preventLinks(),me(this.form)}get editor(){return this.controller.element}get toolbar(){return this.controller.toolbarElement}get form(){return this.controller.formElement}};var k=class{constructor(e){var r;this.controller=e,this.base=this.obfuscate([location.pathname,(r=this.controller.element.closest("[id]"))==null?void 0:r.id].join("/"))}split(e){let r=Math.ceil(e.length/2);return[e.slice(0,r),e.slice(r)]}obfuscate(e){var i;let r=[...e].map(a=>a.charCodeAt(0));return[(i=this.split(r)[1])==null?void 0:i.reverse(),r[0]].flat().join("")}read(e){return sessionStorage.getItem(this.generateStorageKey(e))}write(e,r){return sessionStorage.setItem(this.generateStorageKey(e),r)}remove(e){return sessionStorage.removeItem(this.generateStorageKey(e))}generateStorageKey(e){let r=[...this.obfuscate(e)],[n,i]=this.split(r);return btoa(`${n}/${this.base}/${i}`)}};var W={link:"<a href='{{url}}'>{{label}}</a>",embedded:`
    <span>
      <strong>{{label}}</strong>
      <span>{{description}}</span>
      <del>{{url}}</del>
    </span>
  `,prohibited:`
    <span>
      <strong>{{label}}</strong>
      <span>{{description}}</span>
      <del>{{url}}</del>
    </span>
  `,error:`
    <div data-trix-embed data-trix-embed-error>
      <h1>{{header}}</h1>
      <pre><code>{{error.stack}}</code></pre>
    </div>
  `,iframe:`
    <div data-trix-embed>
      <iframe src='{{src}}' loading='lazy' referrerpolicy='no-referrer' scrolling='no'></iframe>
    </div>
  `,image:`
    <div data-trix-embed>
      <img src='{{src}}' loading='lazy'></img>
    </div>
  `,warning:`
    <div data-trix-embed data-trix-embed-warning>
      <h1>{{header}}</h1>
      <h3>{{subheader}}</h3>

      <h2>{{prohibited.header}}</h2>
      <ul>{{prohibited.hosts}}</ul>

      <h2>{{allowed.header}}</h2>
      <ul>{{allowed.hosts}}</ul>
    </div>
  `};var Pe=[ae,"a","abbr","acronym","address","b","big","blockquote","br","cite","code","dd","del","dfn","div","dl","dt","em","figcaption","figure","h1","h2","h3","h4","h5","h6","hr","i","iframe","img","ins","kbd","li","ol","p","pre","samp","small","span","strong","sub","sup","time","tt","ul","var"],De=["abbr","allow","allowfullscreen","allowpaymentrequest","alt","caption","cite","content-type","credentialless","csp","data-trix-embed","data-trix-embed-error","data-trix-embed-prohibited","data-trix-embed-warning","datetime","filename","filesize","height","href","lang","loading","name","presentation","previewable","referrerpolicy","sandbox","sgid","src","srcdoc","title","url","width","xml:lang"],R=class{constructor(e){this.controller=e,this.initializeTempates()}sanitize(e){let r=document.createElement("template");r.innerHTML=`<div>${e}</div>`;let n=r.content.firstElementChild;return[n].concat([...n.querySelectorAll("*")]).forEach(a=>{Pe.includes(a.tagName.toLowerCase())?[...a.attributes].forEach(s=>{De.includes(s.name.toLowerCase())||a.removeAttribute(s.name)}):a.remove()}),n.innerHTML}initializeTempates(){this.templates=W,Object.keys(W).forEach(e=>this.initializeTemplate(e))}initializeTemplate(e){var a,s;let r=`${e}TemplateValue`,n=this.controller[r],i=n?(s=(a=document.getElementById(n))==null?void 0:a.innerHTML)==null?void 0:s.trim():null;return this.controller[r]=null,i&&(this.templates[e]=i),this.templates[e]}render(e,r={}){return this.templates[e].replace(/{{(.*?)}}/g,(i,a)=>a.split(".").reduce((s,o)=>s[o],r))}renderEmbed(e="https://example.com"){let r=oe(e)?this.render("image",{src:e}):this.render("iframe",{src:e});return this.sanitize(r)}renderEmbeds(e=["https://example.com","https://test.com"]){if(e!=null&&e.length)return e.map(r=>this.renderEmbed(r))}renderWarnings(e=["https://example.com","https://test.com"],r=[],n=[]){if(!(e!=null&&e.length))return;r=[...r].sort(),r.includes("*")&&r.splice(r.indexOf("*"),1),n=[...n],n.includes("*")&&n.splice(n.indexOf("*"),1);let i=[...new Set([...n,...ee(e)])].sort();return this.render("warning",{header:"Copy/Paste Warning",subheader:"Content includes URLs or media from prohibited hosts or restricted protocols.",prohibited:{header:"Prohibited Hosts",hosts:i.length?i.map(a=>`<li>${a}</li>`).join(""):"<li>URLs and media are restricted to allowed hosts and standard protocols.</li>"},allowed:{header:"Allowed Hosts",hosts:r.length?r.map(a=>`<li>${a}</li>`).join(""):"<li>Allowed hosts not configured.</li>"}})}renderError(e){return this.render("error",{header:"Unhandled Exception!",subheader:"Report this problem to a software engineer.",error:e})}};function he(t={Controller:null,Trix:null}){var n;let{Controller:e,Trix:r}=t;return n=class extends e{connect(){this.onpaste=this.paste.bind(this),this.element.addEventListener("trix-paste",this.onpaste,!0),this.store=new k(this),this.guard=new A(this),this.rememberConfig().then(()=>{this.paranoid&&this.guard.protect()})}disconnect(){this.element.removeEventListener("trix-paste",this.onpaste,!0),this.forgetConfig()}async paste(i){this.formElement&&(this.formElement.pasting=!0);try{let{html:a,string:s,range:o}=i.paste,c=a||s||"",d=this.createTemplateElement(c),l=te(d);if(!l.length)return;i.preventDefault(),this.editor.setSelectedRange(o);try{let m=new R(this),u=await this.allowedMediaHosts,h=await this.blockedMediaHosts,p=new Set(l.filter(g=>H(g)));[...d.querySelectorAll("iframe")].forEach(g=>p.add(g.src)),p=[...p];let b=p.filter(g=>j(g,u,h)),v=p.filter(g=>!b.includes(g)),$=await this.allowedLinkHosts,F=await this.blockedLinkHosts,K=l.filter(g=>!p.includes(g)),z=K.filter(g=>j(g,$,F)),I=K.filter(g=>!z.includes(g));if(v.length||I.length){let g=[...new Set([...v,...I])],fe=[...new Set([...u,...$])].filter(C=>!this.reservedDomains.includes(C)),ge=[...new Set([...h,...F])].filter(C=>!this.reservedDomains.includes(C));await this.insert(m.renderWarnings(g,fe,ge))}if(b.length&&await this.insert(m.renderEmbeds(b)),l.length===1&&b.length===1)return;let q=this.sanitizePastedElement(d,{renderer:m,validMediaURLs:b,validLinkURLs:z}).innerHTML.trim();q.length&&await this.insert(q,{disposition:"inline"})}catch(m){this.insert(renderer.renderError(m))}}finally{this.formElement&&delete this.formElement.pasting}}createTemplateElement(i){let a=document.createElement("template");return a.innerHTML=`<div>${i.trim()}</div>`,a.content.firstElementChild}extractLabelFromElement(i,a={default:null}){let s=i.title;return s&&s.length||(s=i.textContent.trim(),s&&s.length)?s:a.default}sanitizePastedElement(i,a={renderer:null,validMediaURLs:[],validLinkURLs:[]}){let{renderer:s,validMediaURLs:o,validLinkURLs:c}=a;i=i.cloneNode(!0);let d=N(i),l=[],m;for(;m=d.nextNode();)m.replacements=m.replacements||new Set,l.push(m),m.nodeValue.split(/\s+/).filter(p=>p.startsWith("http")).forEach(p=>{var v;let f=(v=x(p))==null?void 0:v.href,b=c.includes(f)||c.includes(f)?s.render("link",{url:f,label:f}):s.render("prohibited",{url:f,label:"Prohibited URL:",description:""});m.replacements.add({match:p,replacement:b})});return l.forEach(u=>{if(!u.replacements.size)return;let h=u.nodeValue;[...u.replacements].sort((f,b)=>b.match.length-f.match.length).forEach(f=>h=h.replaceAll(f.match,f.replacement)),u.replaceWith(this.createTemplateElement(h))}),i.querySelectorAll("a").forEach(u=>{let h=M(u),p=this.extractLabelFromElement(u,{default:h}),f=c.includes(h)?s.render("link",{url:h,label:p}):s.render("prohibited",{url:h,label:"Prohibited Link:",description:`(${p})`});u.replaceWith(this.createTemplateElement(f))}),i.querySelectorAll(se.join(", ")).forEach(u=>{let h=M(u),p=this.extractLabelFromElement(u,{default:h}),f=o.includes(h)?s.render("embedded",{url:h,label:"Allowed Media:",description:"(Embedded Above)"}):s.render("prohibited",{url:h,label:"Prohibited Media:",description:""});u.replaceWith(this.createTemplateElement(f))}),i.innerHTML.replaceAll(/(\n|\r|\f|\v)+/g,"<br>"),i}createAttachment(i){return new r.Attachment({content:i,contentType:re.attachment})}insertNewlines(i=1,a={delay:1}){let{delay:s}=a;return new Promise(o=>{setTimeout(()=>{for(let c=0;c<i;c++)this.editor.insertLineBreak();o()},s)})}insertAttachment(i,a={delay:1}){let{delay:s}=a;return new Promise(o=>{setTimeout(()=>{this.editor.insertAttachment(this.createAttachment(i)),this.insertNewlines(1,{delay:s}).finally(o)},s)})}insertHTML(i,a={delay:1}){let{delay:s}=a;return new Promise(o=>{setTimeout(()=>{this.editor.insertHTML(i),this.insertNewlines(1,{delay:s}).finally(o)},s)})}insert(i,a={delay:1,disposition:"attachment"}){let{delay:s,disposition:o}=a;return i!=null&&i.length?new Promise(c=>{setTimeout(()=>{if(typeof i=="string")return o==="inline"?this.insertHTML(i,{delay:s}).catch(d=>this.renderError(d)).finally(c):this.insertAttachment(i,{delay:s}).catch(d=>this.renderError(d)).finally(c);if(Array.isArray(i)){let d=o==="inline"?i.map(l=>this.insertHTML(l,{delay:s+1})):i.map(l=>this.insertAttachment(l,{delay:s+1}));return Promise.all(d).catch(l=>this.renderError(l)).finally(c)}c()})}):Promise.resolve()}get editor(){return this.element.editor}get toolbarElement(){let i=this.element.getAttribute("toolbar"),a=i?document.getElementById(i):null;if(!a){let s=this.element.previousElementSibling;a=s!=null&&s.tagName.match(/trix-toolbar/i)?s:null}return a}get formElement(){return this.element.closest("form")}get inputElement(){var a;let i=this.element.getAttribute("input");return i?(a=this.formElement)==null?void 0:a.querySelector(`#${i}`):null}get paranoid(){return!!this.store.read("paranoid")}get key(){try{return JSON.parse(this.store.read("key"))[2]}catch(i){}}get hostsValueDescriptors(){return Object.values(this.valueDescriptorMap).filter(i=>i.name.endsWith("HostsValue"))}get reservedDomains(){return["embed.example","embed.invalid","embed.local","embed.localhost","embed.test","trix.embed.example","trix.embed.invalid","trix.embed.local","trix.embed.localhost","trix.embed.test","trix.example","trix.invalid","trix.local","trix.localhost","trix.test","www.embed.example","www.embed.invalid","www.embed.local","www.embed.localhost","www.embed.test","www.trix.example","www.trix.invalid","www.trix.local","www.trix.localhost","www.trix.test"]}rememberConfig(){return new Promise(async i=>{let a,s=await T();a=await y(s,w(this.reservedDomains,3)),this.store.write("key",JSON.stringify([a[0],a[1],s,a[2]])),this.paranoidValue!==!1&&(a=await y(s,w(this.reservedDomains,4)),this.store.write("paranoid",JSON.stringify(a))),this.element.removeAttribute("data-trix-embed-paranoid-value"),this.hostsValueDescriptors.forEach(async o=>{let{name:c}=o,d=c.slice(0,c.lastIndexOf("Value")),l=this[c];l.length<4&&(l=l.concat(w(this.reservedDomains,4-l.length))),this.store.write(d,JSON.stringify(await y(s,l))),Object.defineProperty(this,d,{get:async()=>{try{return(await X(this.key,JSON.parse(this.store.read(d)))).filter(u=>!this.reservedDomains.includes(u))}catch(m){return console.error(`Failed to get '${d}'!`,m),[]}}}),this.element.removeAttribute(`data-trix-embed-${o.key}`)}),a=await y(s,w(this.reservedDomains,4)),this.store.write("securityHosts",a),a=await y(s,w(this.reservedDomains,4)),this.store.write("obscurityHosts",a),i()})}forgetConfig(){var i,a,s,o;(i=this.store)==null||i.remove("key"),(a=this.store)==null||a.remove("paranoid"),this.hostsValueDescriptors.forEach(async c=>{var m;let{name:d}=c,l=d.slice(0,d.lastIndexOf("Value"));(m=this.store)==null||m.remove("securityHosts")}),(s=this.store)==null||s.remove("securityHosts"),(o=this.store)==null||o.remove("obscurityHosts")}},_(n,"values",{embeddedTemplate:String,errorTemplate:String,iframeTemplate:String,imageTemplate:String,linkTemplate:String,prohibitedTemplate:String,warningTemplate:String,allowedLinkHosts:Array,blockedLinkHosts:Array,allowedMediaHosts:Array,blockedMediaHosts:Array,paranoid:{type:Boolean,default:!0}}),n}var pe=!1,Ve={application:null,Controller:null,Trix:null};function We(t=Ve){if(pe)return;let{application:e,Controller:r,Trix:n}=t;e.register("trix-embed",he({Controller:r,Trix:n})),pe=!0}self.TrixEmbed=L(E({},B),{encryptValues:y,generateKey:T,generateKeyAndEncryptValues:Q,initialize:We});var Lt=self.TrixEmbed;export{Lt as default};
