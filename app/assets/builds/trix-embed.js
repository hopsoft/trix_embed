/*
  trix-embed 0.0.2 (MIT)
  Copyright Â© 2023 Nate Hopkins (hopsoft) <natehop@gmail.com>
*/
var de=Object.defineProperty,me=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var z=Object.getOwnPropertySymbols;var ue=Object.prototype.hasOwnProperty,pe=Object.prototype.propertyIsEnumerable;var C=(i,e,t)=>e in i?de(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,E=(i,e)=>{for(var t in e||(e={}))ue.call(e,t)&&C(i,t,e[t]);if(z)for(var t of z(e))pe.call(e,t)&&C(i,t,e[t]);return i},L=(i,e)=>me(i,he(e));var F=(i,e,t)=>(C(i,typeof e!="symbol"?e+"":e,t),t);var q={version:"0.0.2"};var R={name:"AES-GCM",length:256},fe=!0,ge=["encrypt","decrypt"];async function be(){let e=["encrypt","decrypt"];return await crypto.subtle.generateKey(R,!0,e)}async function ye(i){let e=await crypto.subtle.exportKey("jwk",i);return JSON.stringify(e)}async function J(i){let e=JSON.parse(i);return await crypto.subtle.importKey("jwk",e,R,fe,ge)}async function xe(i,e){let t=new TextEncoder().encode(String(i)),s=crypto.getRandomValues(new Uint8Array(12)),r=await crypto.subtle.encrypt(L(E({},R),{iv:s}),e,t),a={ciphertext:btoa(String.fromCharCode(...new Uint8Array(r))),iv:btoa(String.fromCharCode(...s))};return btoa(JSON.stringify(a))}async function we(i,e){let t=JSON.parse(atob(i)),s=new Uint8Array(atob(t.ciphertext).split("").map(n=>n.charCodeAt(0))),r=new Uint8Array(atob(t.iv).split("").map(n=>n.charCodeAt(0))),a=await crypto.subtle.decrypt(L(E({},R),{iv:r}),e,s);return new TextDecoder().decode(a)}async function T(){let i=await be(),e=await ye(i);return btoa(e)}async function y(i,e=[]){let t=await J(atob(i));return Promise.all(e.map(s=>xe(s,t)))}async function _(i,e=[]){let t=await J(atob(i));return Promise.all(e.map(s=>we(s,t)))}async function B(i=[]){let e=await T(),t=await y(e,i);return console.log(`data-trix-embed-key-value="${e}"`),console.log(`data-trix-embed-hosts-value='${JSON.stringify(t)}'`),{key:e,encryptedValues:t}}var G=i=>Math.floor(Math.random()*i),w=(i,e=null)=>{let t=[...i];e==="all"&&(e=t.length);let s=t.length,r=[],a=new Set;for(;r.length<e;){let n=G(s);for(;a.has(n);)n=G(s);a.add(n),r.push(t[n])}return typeof e=="number"?r:r[0]};function x(i,e=t=>{}){try{let t=new URL(String(i).trim());return t&&e&&e(t),t}catch(t){console.info(`Failed to parse URL! value='${i}']`)}return null}function X(i,e=t=>{}){var s;let t=(s=x(i))==null?void 0:s.host;return t&&e&&e(t),t}function O(i){return document.createTreeWalker(i,NodeFilter.SHOW_TEXT,e=>e.nodeValue.match(/http/gi)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP)}function ve(i){let e=new Set,t=O(i),s;for(;s=t.nextNode();)s.nodeValue.split(/\s+/).filter(r=>r.startsWith("http")).forEach(r=>x(r,a=>e.add(a.href)));return[...e]}function U(i){if(i.src){let e=i.src.trim();if(e.length)return e}if(i.href){let e=i.href.trim();if(e.length)return e}return""}function Ee(i){let e=new Set;return i.src&&x(i.src,s=>e.add(s.href)),i.href&&x(i.href,s=>e.add(s.href)),i.querySelectorAll("[src], [href]").forEach(s=>x(U(s),r=>e.add(r.href))),[...e]}function N(i,e=[],t=[]){let s=X(i);return t.includes("*")||t.find(r=>s.endsWith(r))?!1:!!(e.find(r=>s.endsWith(r))||e.includes("*")&&(s||i.startsWith("data:")||i.startsWith("news:")||i.startsWith("tel:")))}function Q(i){return[...i.reduce((e,t)=>(X(t,s=>e.add(s)),e),new Set)]}function Y(i){let e=Ee(i),t=ve(i);return[...new Set([...e,...t])]}var Z={attachment:"trix-embed/attachment"};var ee={avif:"image/avif",bmp:"image/bmp",gif:"image/gif",heic:"image/heic",heif:"image/heif",ico:"image/x-icon",jp2:"image/jp2",jpeg:"image/jpeg",jpg:"image/jpeg",jxr:"image/vnd.ms-photo",png:"image/png",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",webp:"image/webp"};var Le=ee,Te=["animate","animateMotion","animateTransform","area","audio","base","embed","feDisplacementMap","feImage","feTile","filter","font-face-uri","iframe","image","link","object","script","source","track","use","video"],Se=["audio","embed","iframe","img","input","script","source","track","video","frame","frameset","object","picture","use"],te="trix-editor",re="action-text-attachment",ie=Te.concat(Se);function ne(i){return!!Object.values(ee).find(e=>e===j(i))}function j(i){let e;if(e=x(i),!e)return null;let t=e.pathname.lastIndexOf(".");if(!t)return null;let s=e.pathname.substring(t+1);return Le[s]}var H={};function se(i){return`${i==null?void 0:i.method}:${i==null?void 0:i.action}`.trim().toLowerCase()}function Ae(i){let e=i.target.closest("form"),t=se(e),s=[...s[t]];if(!s.length)return;let r=s.find(n=>n===e);if(r!=null&&r.pasting&&i.preventDefault(),r)return;s.reduce((n,o)=>{let c=o.closest(te),l=o.querySelector(`#${c.getAttribute("input")}`);return l&&n.push(l),n},[]).forEach(n=>{if(e.querySlector(`[name="${n.name}"]`)||e.querySlector(`#${n.id}`))return i.preventDefault()})}document.addEventListener("submit",Ae,!0);var S=class{constructor(e){this.controller=e}preventAttachments(){var e,t,s,r,a;(e=this.editor)==null||e.removeAttribute("data-direct-upload-url"),(t=this.editor)==null||t.removeAttribute("data-blob-url-template"),(s=this.editor)==null||s.addEventListener("trix-file-accept",n=>n.preventDefault(),!0),(a=(r=this.toolbar)==null?void 0:r.querySelector('[data-trix-button-group="file-tools"]'))==null||a.remove()}async preventLinks(){var s,r;let e=await this.controller.allowedLinkHosts;!(await this.controller.blockedLinkHosts).length&&e.includes("*")||(r=(s=this.toolbar)==null?void 0:s.querySelector('[data-trix-action="link"]'))==null||r.remove()}protect(e=0){if(!this.toolbar&&e<10)return setTimeout(()=>this.protect(e+1),25);if(this.preventAttachments(),this.preventLinks(),!this.form)return;let t=se(this.form);H[t]=H[t]||new Set,H[t].add(this.form)}get editor(){return this.controller.element}get toolbar(){return this.controller.toolbarElement}get form(){return this.controller.formElement}};var A=class{constructor(e){var t;this.controller=e,this.base=this.obfuscate([location.pathname,(t=this.controller.element.closest("[id]"))==null?void 0:t.id].join("/"))}split(e){let t=Math.ceil(e.length/2);return[e.slice(0,t),e.slice(t)]}obfuscate(e){var r;let t=[...e].map(a=>a.charCodeAt(0));return[(r=this.split(t)[1])==null?void 0:r.reverse(),t[0]].flat().join("")}read(e){return sessionStorage.getItem(this.generateStorageKey(e))}write(e,t){return sessionStorage.setItem(this.generateStorageKey(e),t)}remove(e){return sessionStorage.removeItem(this.generateStorageKey(e))}generateStorageKey(e){let t=[...this.obfuscate(e)],[s,r]=this.split(t);return btoa(`${s}/${this.base}/${r}`)}};var P={link:"<a href='{{url}}'>{{label}}</a>",embedded:`
    <span>
      <strong>{{label}}</strong>
      <small>{{description}}</small>
      <del>{{url}}</del>
    </span>
  `,prohibited:`
    <span>
      <strong>{{label}}</strong>
      <del>{{url}}</del>
    </span>
  `,error:`
    <div data-trix-embed data-trix-embed-error>
      <h1>{{header}}</h1>
      <pre><code>{{error.stack}}</code></pre>
    </div>
  `,iframe:`
    <div data-trix-embed>
      <iframe src='{{src}}' loading='lazy' referrerpolicy='no-referrer' scrolling='no'></iframe>
    </div>
  `,image:`
    <div data-trix-embed>
      <img src='{{src}}' loading='lazy'></img>
    </div>
  `,warning:`
    <div data-trix-embed data-trix-embed-warning>
      <h1>{{header}}</h1>
      <h3>{{subheader}}</h3>

      <h2>{{prohibited.header}}</h2>
      <ul>{{prohibited.hosts}}</ul>

      <h2>{{allowed.header}}</h2>
      <ul>{{allowed.hosts}}</ul>
    </div>
  `};var ke=[re,"a","abbr","acronym","address","b","big","blockquote","br","cite","code","dd","del","dfn","div","dl","dt","em","figcaption","figure","h1","h2","h3","h4","h5","h6","hr","i","iframe","img","ins","kbd","li","ol","p","pre","samp","small","span","strong","sub","sup","time","tt","ul","var"],Re=["abbr","allow","allowfullscreen","allowpaymentrequest","alt","caption","cite","content-type","credentialless","csp","data-trix-embed","data-trix-embed-error","data-trix-embed-prohibited","data-trix-embed-warning","datetime","filename","filesize","height","href","lang","loading","name","presentation","previewable","referrerpolicy","sandbox","sgid","src","srcdoc","title","url","width","xml:lang"],k=class{constructor(e){this.controller=e,this.initializeTempates()}sanitize(e){let t=document.createElement("template");t.innerHTML=`<div>${e}</div>`;let s=t.content.firstElementChild;return[s].concat([...s.querySelectorAll("*")]).forEach(a=>{ke.includes(a.tagName.toLowerCase())?[...a.attributes].forEach(n=>{Re.includes(n.name.toLowerCase())||a.removeAttribute(n.name)}):a.remove()}),s.innerHTML}initializeTempates(){this.templates=P,Object.keys(P).forEach(e=>this.initializeTemplate(e))}initializeTemplate(e){var a,n;let t=`${e}TemplateValue`,s=this.controller[t],r=s?(n=(a=document.getElementById(s))==null?void 0:a.innerHTML)==null?void 0:n.trim():null;return this.controller[t]=null,r&&(this.templates[e]=r),this.templates[e]}render(e,t={}){return this.templates[e].replace(/{{(.*?)}}/g,(r,a)=>a.split(".").reduce((n,o)=>n[o],t))}renderEmbed(e="https://example.com"){let t=ne(e)?this.render("image",{src:e}):this.render("iframe",{src:e});return this.sanitize(t)}renderEmbeds(e=["https://example.com","https://test.com"]){if(e!=null&&e.length)return e.map(t=>this.renderEmbed(t))}renderWarnings(e=["https://example.com","https://test.com"],t=[],s=[]){if(!(e!=null&&e.length))return;t=[...t].sort(),t.includes("*")&&t.splice(t.indexOf("*"),1),s=[...s],s.includes("*")&&s.splice(s.indexOf("*"),1);let r=[...new Set([...s,...Q(e)])].sort();return this.render("warning",{header:"Copy/Paste Warning",subheader:"Content includes URLs or media from prohibited hosts or restricted protocols.",prohibited:{header:"Prohibited Hosts",hosts:r.length?r.map(a=>`<li>${a}</li>`).join(""):"<li>URLs and media are restricted to allowed hosts and standard protocols.</li>"},allowed:{header:"Allowed Hosts",hosts:t.length?t.map(a=>`<li>${a}</li>`).join(""):"<li>Allowed hosts not configured.</li>"}})}renderError(e){return this.render("error",{header:"Unhandled Exception!",subheader:"Report this problem to a software engineer.",error:e})}};function ae(i={Controller:null,Trix:null}){var s;let{Controller:e,Trix:t}=i;return s=class extends e{connect(){this.onpaste=this.paste.bind(this),this.element.addEventListener("trix-paste",this.onpaste,!0),this.store=new A(this),this.guard=new S(this),this.rememberConfig().then(()=>{this.paranoid&&this.guard.protect()})}disconnect(){this.element.removeEventListener("trix-paste",this.onpaste,!0),this.forgetConfig()}async paste(r){this.formElement&&(this.formElement.pasting=!0);try{let{html:a,string:n,range:o}=r.paste,c=a||n||"",l=this.createTemplateElement(c),d=Y(l);if(!d.length)return;r.preventDefault(),this.editor.setSelectedRange(o);try{let m=new k(this),h=await this.allowedMediaHosts,u=await this.blockedMediaHosts,p=new Set(d.filter(g=>j(g)));[...l.querySelectorAll("iframe")].forEach(g=>p.add(g.src)),p=[...p];let b=p.filter(g=>N(g,h,u)),v=p.filter(g=>!b.includes(g)),V=await this.allowedLinkHosts,W=await this.blockedLinkHosts,D=d.filter(g=>!p.includes(g)),K=D.filter(g=>N(g,V,W)),$=D.filter(g=>!K.includes(g));if(v.length||$.length){let g=[...new Set([...v,...$])],le=[...new Set([...h,...V])].filter(M=>!this.reservedDomains.includes(M)),ce=[...new Set([...u,...W])].filter(M=>!this.reservedDomains.includes(M));await this.insert(m.renderWarnings(g,le,ce))}if(b.length&&await this.insert(m.renderEmbeds(b)),d.length===1&&b.length===1)return;let I=this.sanitizePastedElement(l,{renderer:m,validMediaURLs:b,validLinkURLs:K}).innerHTML.trim();I.length&&await this.insert(I,{disposition:"inline"})}catch(m){this.insert(renderer.renderError(m))}}finally{this.formElement&&delete this.formElement.pasting}}createTemplateElement(r){let a=document.createElement("template");return a.innerHTML=`<div>${r.trim()}</div>`,a.content.firstElementChild}extractLabelFromElement(r,a={default:null}){let n=r.title;return n&&n.length||(n=r.textContent.trim(),n&&n.length)?n:a.default}sanitizePastedElement(r,a={renderer:null,validMediaURLs:[],validLinkURLs:[]}){let{renderer:n,validMediaURLs:o,validLinkURLs:c}=a;r=r.cloneNode(!0);let l=O(r),d=[],m;for(;m=l.nextNode();)m.replacements=m.replacements||new Set,d.push(m),m.nodeValue.split(/\s+/).filter(p=>p.startsWith("http")).forEach(p=>{var v;let f=(v=x(p))==null?void 0:v.href,b=c.includes(f)||c.includes(f)?n.render("link",{url:f,label:f}):n.render("prohibited",{url:f,label:"Prohibited URL"});m.replacements.add({match:p,replacement:b})});return d.forEach(h=>{if(!h.replacements.size)return;let u=h.nodeValue;[...h.replacements].sort((f,b)=>b.match.length-f.match.length).forEach(f=>u=u.replaceAll(f.match,f.replacement)),h.replaceWith(this.createTemplateElement(u))}),r.querySelectorAll("a").forEach(h=>{let u=U(h),p=this.extractLabelFromElement(h,{default:u}),f=c.includes(u)?n.render("link",{url:u,label:p}):n.render("prohibited",{url:u,label:"Prohibited link"});h.replaceWith(this.createTemplateElement(f))}),r.querySelectorAll(ie.join(", ")).forEach(h=>{let u=U(h),p=this.extractLabelFromElement(h,{default:u}),f=o.includes(u)?n.render("embedded",{url:u,label:"Allowed Media",description:"(embedded above)"}):n.render("prohibited",{url:u,label:"Prohibited media"});h.replaceWith(this.createTemplateElement(f))}),r.innerHTML.replaceAll(/(\n|\r|\f|\v)+/g,"<br>"),r}createAttachment(r){return new t.Attachment({content:r,contentType:Z.attachment})}insertNewlines(r=1,a={delay:1}){let{delay:n}=a;return new Promise(o=>{setTimeout(()=>{for(let c=0;c<r;c++)this.editor.insertLineBreak();o()},n)})}insertAttachment(r,a={delay:1}){let{delay:n}=a;return new Promise(o=>{setTimeout(()=>{this.editor.insertAttachment(this.createAttachment(r)),this.insertNewlines(1,{delay:n}).finally(o)},n)})}insertHTML(r,a={delay:1}){let{delay:n}=a;return new Promise(o=>{setTimeout(()=>{this.editor.insertHTML(r),this.insertNewlines(1,{delay:n}).finally(o)},n)})}insert(r,a={delay:1,disposition:"attachment"}){let{delay:n,disposition:o}=a;return r!=null&&r.length?new Promise(c=>{setTimeout(()=>{if(typeof r=="string")return o==="inline"?this.insertHTML(r,{delay:n}).catch(l=>this.renderError(l)).finally(c):this.insertAttachment(r,{delay:n}).catch(l=>this.renderError(l)).finally(c);if(Array.isArray(r)){let l=o==="inline"?r.map(d=>this.insertHTML(d,{delay:n+1})):r.map(d=>this.insertAttachment(d,{delay:n+1}));return Promise.all(l).catch(d=>this.renderError(d)).finally(c)}c()})}):Promise.resolve()}get editor(){return this.element.editor}get toolbarElement(){let r=this.element.getAttribute("toolbar"),a=r?document.getElementById(r):null;if(!a){let n=this.element.previousElementSibling;a=n!=null&&n.tagName.match(/trix-toolbar/i)?n:null}return a}get formElement(){return this.element.closest("form")}get inputElement(){var a;let r=this.element.getAttribute("input");return r?(a=this.formElement)==null?void 0:a.querySelector(`#${r}`):null}get paranoid(){return!!this.store.read("paranoid")}get key(){try{return JSON.parse(this.store.read("key"))[2]}catch(r){}}get hostsValueDescriptors(){return Object.values(this.valueDescriptorMap).filter(r=>r.name.endsWith("HostsValue"))}get reservedDomains(){return["embed.example","embed.invalid","embed.local","embed.localhost","embed.test","trix.embed.example","trix.embed.invalid","trix.embed.local","trix.embed.localhost","trix.embed.test","trix.example","trix.invalid","trix.local","trix.localhost","trix.test","www.embed.example","www.embed.invalid","www.embed.local","www.embed.localhost","www.embed.test","www.trix.example","www.trix.invalid","www.trix.local","www.trix.localhost","www.trix.test"]}rememberConfig(){return new Promise(async r=>{let a,n=await T();a=await y(n,w(this.reservedDomains,3)),this.store.write("key",JSON.stringify([a[0],a[1],n,a[2]])),this.paranoidValue!==!1&&(a=await y(n,w(this.reservedDomains,4)),this.store.write("paranoid",JSON.stringify(a))),this.element.removeAttribute("data-trix-embed-paranoid-value"),this.hostsValueDescriptors.forEach(async o=>{let{name:c}=o,l=c.slice(0,c.lastIndexOf("Value")),d=this[c];d.length<4&&(d=d.concat(w(this.reservedDomains,4-d.length))),this.store.write(l,JSON.stringify(await y(n,d))),Object.defineProperty(this,l,{get:async()=>{try{return(await _(this.key,JSON.parse(this.store.read(l)))).filter(h=>!this.reservedDomains.includes(h))}catch(m){return console.error(`Failed to get '${l}'!`,m),[]}}}),this.element.removeAttribute(`data-trix-embed-${o.key}`)}),a=await y(n,w(this.reservedDomains,4)),this.store.write("securityHosts",a),a=await y(n,w(this.reservedDomains,4)),this.store.write("obscurityHosts",a),r()})}forgetConfig(){var r,a,n,o;(r=this.store)==null||r.remove("key"),(a=this.store)==null||a.remove("paranoid"),this.hostsValueDescriptors.forEach(async c=>{var m;let{name:l}=c,d=l.slice(0,l.lastIndexOf("Value"));(m=this.store)==null||m.remove("securityHosts")}),(n=this.store)==null||n.remove("securityHosts"),(o=this.store)==null||o.remove("obscurityHosts")}},F(s,"values",{embeddedTemplate:String,errorTemplate:String,iframeTemplate:String,imageTemplate:String,linkTemplate:String,prohibitedTemplate:String,warningTemplate:String,allowedLinkHosts:Array,blockedLinkHosts:Array,allowedMediaHosts:Array,blockedMediaHosts:Array,paranoid:{type:Boolean,default:!0}}),s}var oe=!1,Ue={application:null,Controller:null,Trix:null};function Me(i=Ue){if(oe)return;let{application:e,Controller:t,Trix:s}=i;e.register("trix-embed",ae({Controller:t,Trix:s})),oe=!0}self.TrixEmbed=L(E({},q),{encryptValues:y,generateKey:T,generateKeyAndEncryptValues:B,initialize:Me});var ht=self.TrixEmbed;export{ht as default};
