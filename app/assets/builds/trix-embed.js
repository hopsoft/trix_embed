/*
  trix-embed 0.0.2 (MIT)
  Copyright Â© 2023 Nate Hopkins (hopsoft) <natehop@gmail.com>
*/
var Z=Object.defineProperty,ee=Object.defineProperties;var te=Object.getOwnPropertyDescriptors;var K=Object.getOwnPropertySymbols;var re=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var C=(i,e,t)=>e in i?Z(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,w=(i,e)=>{for(var t in e||(e={}))re.call(e,t)&&C(i,t,e[t]);if(K)for(var t of K(e))ie.call(e,t)&&C(i,t,e[t]);return i},v=(i,e)=>ee(i,te(e));var R=(i,e,t)=>(C(i,typeof e!="symbol"?e+"":e,t),t);var P={author:"Nate Hopkins (hopsoft) <natehop@gmail.com>",copyright:"Copyright \xA9 2023 Nate Hopkins (hopsoft) <natehop@gmail.com>",description:"A Stimulus controller to safely embed external media in the Trix editor",license:"MIT",repository:"https://github.com/hopsoft/trix_embed",version:"0.0.2"};var U={name:"AES-GCM",length:256},ne=!0,oe=["encrypt","decrypt"];async function ae(){let e=["encrypt","decrypt"];return await crypto.subtle.generateKey(U,!0,e)}async function se(i){let e=await crypto.subtle.exportKey("jwk",i);return JSON.stringify(e)}async function D(i){let e=JSON.parse(i);return await crypto.subtle.importKey("jwk",e,U,ne,oe)}async function le(i,e){let t=new TextEncoder().encode(String(i)),n=crypto.getRandomValues(new Uint8Array(12)),r=await crypto.subtle.encrypt(v(w({},U),{iv:n}),e,t),o={ciphertext:btoa(String.fromCharCode(...new Uint8Array(r))),iv:btoa(String.fromCharCode(...n))};return btoa(JSON.stringify(o))}async function ce(i,e){let t=JSON.parse(atob(i)),n=new Uint8Array(atob(t.ciphertext).split("").map(a=>a.charCodeAt(0))),r=new Uint8Array(atob(t.iv).split("").map(a=>a.charCodeAt(0))),o=await crypto.subtle.decrypt(v(w({},U),{iv:r}),e,n);return new TextDecoder().decode(o)}async function E(){let i=await ae(),e=await se(i);return btoa(e)}async function x(i,e=[]){let t=await D(atob(i));return Promise.all(e.map(n=>le(n,t)))}async function V(i,e=[]){let t=await D(atob(i));return Promise.all(e.map(n=>ce(n,t)))}async function q(i=[]){let e=await E(),t=await x(e,i);return console.log(`data-trix-embed-key-value="${e}"`),console.log(`data-trix-embed-hosts-value='${JSON.stringify(t)}'`),{key:e,encryptedValues:t}}function g(i,e=t=>{}){try{let t=new URL(String(i).trim());return t&&e&&e(t),t}catch(t){console.info(`Failed to parse URL! value='${i}']`)}return null}function W(i,e=t=>{}){var n;let t=(n=g(i))==null?void 0:n.host;return t&&e&&e(t),t}function k(i){return document.createTreeWalker(i,NodeFilter.SHOW_TEXT,e=>e.nodeValue.match(/http/gi)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP)}function me(i){let e=new Set,t=k(i),n;for(;n=t.nextNode();)n.nodeValue.split(/\s+/).filter(r=>r.startsWith("http")).forEach(r=>g(r,o=>e.add(o.href)));return[...e]}function N(i){if(i.src){let e=i.src.trim();if(e.length)return e}if(i.href){let e=i.href.trim();if(e.length)return e}return""}function de(i){let e=new Set;return i.src&&g(i.src,n=>e.add(n.href)),i.href&&g(i.href,n=>e.add(n.href)),i.querySelectorAll("[src], [href]").forEach(n=>g(N(n),r=>e.add(r.href))),[...e]}function M(i,e=[]){let t=W(i);return t?!!e.find(n=>t.includes(n)):!1}function z(i){return[...i.reduce((e,t)=>(W(t,n=>e.add(n)),e),new Set)]}function F(i){let e=de(i),t=me(i);return[...new Set([...e,...t])]}var J={avif:"image/avif",bmp:"image/bmp",gif:"image/gif",heic:"image/heic",heif:"image/heif",ico:"image/x-icon",jp2:"image/jp2",jpeg:"image/jpeg",jpg:"image/jpeg",jxr:"image/vnd.ms-photo",png:"image/png",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",webp:"image/webp"};var he=J,ue=["animate","animateMotion","animateTransform","area","audio","base","embed","feDisplacementMap","feImage","feTile","filter","font-face-uri","iframe","image","link","object","script","source","track","use","video"],pe=["audio","embed","iframe","img","input","script","source","track","video","frame","frameset","object","picture","use"],B="action-text-attachment",_=ue.concat(pe);function G(i){return!!Object.values(J).find(e=>e===O(i))}function O(i){let e;if(e=g(i),!e)return null;let t=e.pathname.lastIndexOf(".");if(!t)return null;let n=e.pathname.substring(t+1);return he[n]}var H={},T=class{constructor(e){R(this,"protectSubmit",e=>{let t=this.controller.formElement,n=e.target.closest("form");n&&n.action===t.action&&n.method===t.method&&n!==t&&e.preventDefault()});this.controller=e}preventAttachments(){var e;(e=this.controller.toolbarElement.querySelector('[data-trix-button-group="file-tools"]'))==null||e.remove(),this.controller.element.removeAttribute("data-direct-upload-url"),this.controller.element.removeAttribute("data-blob-url-template"),this.controller.element.addEventListener("trix-file-accept",t=>t.preventDefault())}preventLinks(){var e;(e=this.controller.toolbarElement.querySelector('[data-trix-action="link"]'))==null||e.remove()}protect(){if(this.preventAttachments(),this.preventLinks(),!this.controller.formElement)return;let e=this.controller.formElement,t=this.controller.inputElement,n=`${e.method}${e.action}`;document.removeEventListener("submit",H[n],!0),H[n]=this.protectSubmit.bind(this),document.addEventListener("submit",H[n],!0),new MutationObserver((o,a)=>{o.forEach(d=>{let{addedNodes:p,target:u,type:m}=d;switch(m){case"attributes":let l=node.closest("form");e!=null&&e.action&&e.action===(l==null?void 0:l.action)&&(u.id===t.id||u.name===t.name)&&u.remove();break;case"childList":p.forEach(c=>{if(c.nodeType===Node.ELEMENT_NODE){let s=c.closest("form");e!=null&&e.action&&e.action===(s==null?void 0:s.action)?s!==e&&c.remove():t!=null&&t.name&&t.name===(c==null?void 0:c.name)&&c.remove()}});break}})}).observe(document.body,{attributeFilter:["id","name"],attributes:!0,childList:!0,subtree:!0})}cleanup(){let e=this.controller.element,t=this.controller.inputElement,n=this.controller.toolbarElement;t==null||t.remove(),n==null||n.remove(),e==null||e.remove()}};var L=class{constructor(e){var t;this.controller=e,this.base=this.obfuscate([location.pathname,(t=this.controller.element.closest("[id]"))==null?void 0:t.id].join("/"))}split(e){let t=Math.ceil(e.length/2);return[e.slice(0,t),e.slice(t)]}obfuscate(e){var r;let t=[...e].map(o=>o.charCodeAt(0));return[(r=this.split(t)[1])==null?void 0:r.reverse(),t[0]].flat().join("")}read(e){return sessionStorage.getItem(this.generateStorageKey(e))}write(e,t){return sessionStorage.setItem(this.generateStorageKey(e),t)}remove(e){return sessionStorage.removeItem(this.generateStorageKey(e))}generateStorageKey(e){let t=[...this.obfuscate(e)],[n,r]=this.split(t);return btoa(`${n}/${this.base}/${r}`)}};var fe={iframe:"<div><iframe></iframe></div>",image:"<div><img></img></div>",warning:`
    <div>
      <h1>Copy/Paste Warning</h1>
      <hr>
      <h3>The pasted content includes media from unsupported hosts.</h3>
      <h2>Prohibited Hosts</h2>
      <ul data-list="prohibited-hosts">
        <li>Media is only supported from allowed hosts.</li>
      </ul>
      <h2>Allowed Hosts</h2>
      <ul data-list="allowed-hosts">
        <li>Allowed hosts not configured.</li>
      </ul>
    </div>
  `,error:`
    <div style='background-color:lightyellow; color:red; border:solid 1px red; padding:20px;'>
      <h1>Unhandled Exception!</h1>
      <p>Show a programmer the message below.</p>
      <pre style="background-color:darkslategray; color:whitesmoke; padding:10px;"><code></code></pre>
    </div>
  `};function X(i){let e=document.createElement("template");return e.innerHTML=fe[i],e}var ge=`${B} a abbr acronym address b big blockquote br cite code dd del dfn div dl dt em figcaption figure h1 h2 h3 h4 h5 h6 hr i iframe img ins kbd li ol p pre samp small span strong sub sup time tt ul var`.split(" "),be="abbr allow allowfullscreen allowpaymentrequest alt caption cite content-type credentialless csp datetime filename filesize height href lang loading name presentation previewable referrerpolicy sandbox sgid src srcdoc title url width xml:lang".split(" "),S=class{constructor(e){this.controller=e,this.initializeTempates()}sanitize(e){return[e].concat([...e.querySelectorAll("*")]).forEach(n=>{ge.includes(n.tagName.toLowerCase())?[...n.attributes].forEach(r=>{be.includes(r.name.toLowerCase())||n.removeAttribute(r.name)}):n.remove()}),e}initializeTempates(){["error","iframe","image","warning"].forEach(t=>this.initializeTemplate(t))}initializeTemplate(e){let t,n=`${e}Template`,r=`${n}Value`;this.controller[`has${r.charAt(0).toUpperCase()+r.slice(1)}`]&&(t=document.getElementById(this.controller[r])),this[n]=t||X(e),this.controller[r]=null}renderEmbed(e="https://example.com"){let t;if(G(e)){t=this.imageTemplate.content.firstElementChild.cloneNode(!0);let n=t.tagName.match(/img/i)?t:t.querySelector("img");n.src=e}else{t=this.iframeTemplate.content.firstElementChild.cloneNode(!0);let n=t.tagName.match(/iframe/i)?t:t.querySelector("iframe");n.src=e}return this.sanitize(t).outerHTML}renderEmbeds(e=["https://example.com","https://test.com"]){if(e!=null&&e.length)return e.map(t=>this.renderEmbed(t))}renderWarnings(e=["https://example.com","https://test.com"],t=[]){if(!(e!=null&&e.length))return;let n=this.warningTemplate.content.firstElementChild.cloneNode(!0),r=n.querySelector('[data-list="prohibited-hosts"]'),o=n.querySelector('[data-list="allowed-hosts"]');if(r){let a=z(e).sort();a.length&&(r.innerHTML=a.map(d=>`<li>${d}</li>`).join(""))}return o&&t.length&&(o.innerHTML=t.map(a=>`<li>${a}</li>`).join("")),n.outerHTML}renderError(e){let t=this.errorTemplate.content.firstElementChild.cloneNode(!0),n=t.querySelector("code");return n.innerHTML=e.message,t.outerHTML}};var ye={Controller:null,Trix:null};function Q(i=ye){var n;let{Controller:e,Trix:t}=i;return n=class extends e{async connect(){this.guard=new T(this),this.paranoidValue&&this.guard.protect(),this.store=new L(this),await this.rememberConfig(),this.onpaste=this.paste.bind(this),this.element.addEventListener("trix-paste",this.onpaste,!0),window.addEventListener("beforeunload",()=>this.disconnect())}disconnect(){this.element.removeEventListener("trix-paste",this.onpaste,!0),this.paranoid&&this.guard.cleanup(),this.forgetConfig()}async paste(r){let{html:o,string:a,range:d}=r.paste,p=o||a||"",u=this.createTemplateElement(p),m=F(u);if(!m.length)return;r.preventDefault(),this.editor.setSelectedRange(d);let l=await this.hosts,c=new S(this);try{let s=new Set(m.filter(f=>O(f)));[...u.querySelectorAll("iframe")].forEach(f=>s.add(f.src)),s=[...s];let b=s.filter(f=>M(f,l)),A=s.filter(f=>!b.includes(f)),I=m.filter(f=>!s.includes(f)),$=I.filter(f=>M(f,l)),ve=I.filter(f=>!$.includes(f)),y;if(y=A,y.length&&await this.insert(c.renderWarnings(y,l.sort())),y=b,y.length&&await this.insert(c.renderEmbeds(y)),m.length===1&&b.length===1)return;let j=this.sanitizePastedElement(u,{validMediaURLs:b,validStandardURLs:$}).innerHTML.trim();j.length&&await this.insert(`<br><br>${j}`,{disposition:"inline"})}catch(s){this.insert(c.renderError(s))}}createTemplateElement(r){let o=document.createElement("template");return o.innerHTML=`<div>${r.trim()}</div>`,o.content.firstElementChild}extractLabelFromElement(r,o={default:null}){let a=r.title;return a&&a.length||(a=r.textContent.trim(),a&&a.length)?a:o.default}sanitizePastedElement(r,o={validMediaURLs:[],validStandardURLs:[]}){let{validMediaURLs:a,validStandardURLs:d}=o;r=r.cloneNode(!0);let p=k(r),u=[],m;for(;m=p.nextNode();)m.replacements=m.replacements||new Set,u.push(m),m.nodeValue.split(/\s+/).filter(s=>s.startsWith("http")).forEach(s=>{var A;let h=(A=g(s))==null?void 0:A.href,b=d.includes(h)||d.includes(h)?`<a href="${h}">${h}</a>`:`<del><strong>PROHIBITED LINK:</strong> ${h}</del>`;m.replacements.add({match:s,replacement:b})});return u.forEach(l=>{if(!l.replacements.size)return;let c=l.nodeValue;[...l.replacements].sort((h,b)=>b.match.length-h.match.length).forEach(h=>c=c.replaceAll(h.match,h.replacement)),l.replaceWith(this.createTemplateElement(c))}),r.querySelectorAll("a").forEach(l=>{let c=N(l),s=this.extractLabelFromElement(l,{default:c}),h=d.includes(c)?`<a href="${c}">${s}</a>`:`<del><strong>PROHIBITED LINK:</strong> ${s}</del>`;l.replaceWith(this.createTemplateElement(h))}),r.querySelectorAll(_.join(", ")).forEach(l=>{let c=N(l),s=this.extractLabelFromElement(l,{default:c}),h=a.includes(c)?`<del><strong>ALLOWED MEDIA (embedded above):</strong> ${s}</del>`:`<del><strong>PROHIBITED MEDIA:</strong> ${s}</del>`;l.replaceWith(this.createTemplateElement(h))}),r.innerHTML.replaceAll(/(\n|\r|\f|\v)+/g,"<br>"),r}insertAttachment(r,o={delay:0}){let{delay:a}=o;return new Promise(d=>{setTimeout(()=>{let p=new t.Attachment({content:r,contentType:this.attachmentContentType});this.editor.insertAttachment(p),d()},a)})}insertHTML(r,o={delay:0}){let{delay:a}=o;return new Promise(d=>{setTimeout(()=>{this.editor.insertHTML(r),this.editor.moveCursorInDirection("forward"),this.editor.insertLineBreak(),this.editor.moveCursorInDirection("backward"),d()},a)})}insert(r,o={delay:0,disposition:"attachment"}){let{delay:a,disposition:d}=o;return r!=null&&r.length?new Promise(p=>{setTimeout(()=>{if(typeof r=="string")return d==="inline"?this.insertHTML(r,{delay:a}).then(p):this.insertAttachment(r,{delay:a}).then(p);if(Array.isArray(r))return d==="inline"?r.reduce((u,m,l)=>u.then(this.insertHTML(m,{delay:a})),Promise.resolve()).then(p):r.reduce((u,m,l)=>u.then(this.insertAttachment(m,{delay:a})),Promise.resolve()).then(p);p()})}):Promise.resolve()}get attachmentContentType(){return"trix-embed/attachment"}get editor(){return this.element.editor}get toolbarElement(){let r=this.element.previousElementSibling;return r!=null&&r.tagName.match(/trix-toolbar/i)?r:null}get inputElement(){var r;return((r=this.formElement)==null?void 0:r.querySelector(`#${this.element.getAttribute("input")}`))||document.getElementById(this.element.getAttribute("input"))}get formElement(){return this.element.closest("form")}get paranoid(){return!!this.store.read("paranoid")}get key(){try{return JSON.parse(this.store.read("key"))[2]}catch(r){}}get hosts(){try{return V(this.key,JSON.parse(this.store.read("hosts")))}catch(r){return[]}}get reservedDomains(){return["embed.example","embed.invalid","embed.local","embed.localhost","embed.test","trix.embed.example","trix.embed.invalid","trix.embed.local","trix.embed.localhost","trix.embed.test","trix.example","trix.invalid","trix.local","trix.localhost","trix.test","www.embed.example","www.embed.invalid","www.embed.local","www.embed.localhost","www.embed.test","www.trix.example","www.trix.invalid","www.trix.local","www.trix.localhost","www.trix.test"]}async rememberConfig(){let r=await E(),o=new Set;for(;o.size<3;)o.add(this.reservedDomains[Math.floor(Math.random()*this.reservedDomains.length)]);o=await x(r,[...o]);let a=await x(r,this.hostsValue);this.store.write("key",JSON.stringify([o[0],o[1],r,o[2]])),this.element.removeAttribute("data-trix-embed-key-value"),this.store.write("hosts",JSON.stringify(a)),this.element.removeAttribute("data-trix-embed-hosts-value"),this.paranoidValue!==!1&&(this.store.write("paranoid",JSON.stringify(o.slice(3))),this.element.removeAttribute("data-trix-embed-paranoid"))}forgetConfig(){this.store.remove("key"),this.store.remove("hosts"),this.store.remove("paranoid")}},R(n,"values",{warningTemplate:String,iframeTemplate:String,imageTemplate:String,hosts:Array,paranoid:{type:Boolean,default:!0}}),n}var Y=!1,xe={application:null,Controller:null,Trix:null};function we(i=xe){if(Y)return;let{application:e,Controller:t,Trix:n}=i;e.register("trix-embed",Q({Controller:t,Trix:n})),Y=!0}self.TrixEmbed=v(w({},P),{encryptValues:x,generateKey:E,generateKeyAndEncryptValues:q,initialize:we});var Ze=self.TrixEmbed;export{Ze as default};
