/*
  trix-embed 0.0.2 (MIT)
  Copyright Â© 2023 Nate Hopkins (hopsoft) <natehop@gmail.com>
*/
var re=Object.defineProperty,ie=Object.defineProperties;var ne=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var ae=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var M=(r,e,t)=>e in r?re(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,v=(r,e)=>{for(var t in e||(e={}))ae.call(e,t)&&M(r,t,e[t]);if(H)for(var t of H(e))se.call(e,t)&&M(r,t,e[t]);return r},T=(r,e)=>ie(r,ne(e));var V=(r,e,t)=>(M(r,typeof e!="symbol"?e+"":e,t),t);var W={author:"Nate Hopkins (hopsoft) <natehop@gmail.com>",copyright:"Copyright \xA9 2023 Nate Hopkins (hopsoft) <natehop@gmail.com>",description:"A Stimulus controller to safely embed external media in the Trix editor",license:"MIT",repository:"https://github.com/hopsoft/trix_embed",version:"0.0.2"};var U={name:"AES-GCM",length:256},oe=!0,le=["encrypt","decrypt"];async function ce(){let e=["encrypt","decrypt"];return await crypto.subtle.generateKey(U,!0,e)}async function de(r){let e=await crypto.subtle.exportKey("jwk",r);return JSON.stringify(e)}async function I(r){let e=JSON.parse(r);return await crypto.subtle.importKey("jwk",e,U,oe,le)}async function me(r,e){let t=new TextEncoder().encode(String(r)),s=crypto.getRandomValues(new Uint8Array(12)),i=await crypto.subtle.encrypt(T(v({},U),{iv:s}),e,t),n={ciphertext:btoa(String.fromCharCode(...new Uint8Array(i))),iv:btoa(String.fromCharCode(...s))};return btoa(JSON.stringify(n))}async function he(r,e){let t=JSON.parse(atob(r)),s=new Uint8Array(atob(t.ciphertext).split("").map(a=>a.charCodeAt(0))),i=new Uint8Array(atob(t.iv).split("").map(a=>a.charCodeAt(0))),n=await crypto.subtle.decrypt(T(v({},U),{iv:i}),e,s);return new TextDecoder().decode(n)}async function E(){let r=await ce(),e=await de(r);return btoa(e)}async function y(r,e=[]){let t=await I(atob(r));return Promise.all(e.map(s=>me(s,t)))}async function F(r,e=[]){let t=await I(atob(r));return Promise.all(e.map(s=>he(s,t)))}async function $(r=[]){let e=await E(),t=await y(e,r);return console.log(`data-trix-embed-key-value="${e}"`),console.log(`data-trix-embed-hosts-value='${JSON.stringify(t)}'`),{key:e,encryptedValues:t}}function b(r,e=t=>{}){try{let t=new URL(String(r).trim());return t&&e&&e(t),t}catch(t){console.info(`Failed to parse URL! value='${r}']`)}return null}function q(r,e=t=>{}){var s;let t=(s=b(r))==null?void 0:s.host;return t&&e&&e(t),t}function C(r){return document.createTreeWalker(r,NodeFilter.SHOW_TEXT,e=>e.nodeValue.match(/http/gi)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP)}function pe(r){let e=new Set,t=C(r),s;for(;s=t.nextNode();)s.nodeValue.split(/\s+/).filter(i=>i.startsWith("http")).forEach(i=>b(i,n=>e.add(n.href)));return[...e]}function k(r){if(r.src){let e=r.src.trim();if(e.length)return e}if(r.href){let e=r.href.trim();if(e.length)return e}return""}function ue(r){let e=new Set;return r.src&&b(r.src,s=>e.add(s.href)),r.href&&b(r.href,s=>e.add(s.href)),r.querySelectorAll("[src], [href]").forEach(s=>b(k(s),i=>e.add(i.href))),[...e]}function N(r,e=[]){let t=q(r);return t?!!e.find(s=>t.includes(s)):!1}function D(r){return[...r.reduce((e,t)=>(q(t,s=>e.add(s)),e),new Set)]}function J(r){let e=ue(r),t=pe(r);return[...new Set([...e,...t])]}var _={attachment:"trix-embed/attachment"};var B={avif:"image/avif",bmp:"image/bmp",gif:"image/gif",heic:"image/heic",heif:"image/heif",ico:"image/x-icon",jp2:"image/jp2",jpeg:"image/jpeg",jpg:"image/jpeg",jxr:"image/vnd.ms-photo",png:"image/png",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",webp:"image/webp"};var fe=B,ge=["animate","animateMotion","animateTransform","area","audio","base","embed","feDisplacementMap","feImage","feTile","filter","font-face-uri","iframe","image","link","object","script","source","track","use","video"],be=["audio","embed","iframe","img","input","script","source","track","video","frame","frameset","object","picture","use"],G="action-text-attachment",X=ge.concat(be);function Q(r){return!!Object.values(B).find(e=>e===j(r))}function j(r){let e;if(e=b(r),!e)return null;let t=e.pathname.lastIndexOf(".");if(!t)return null;let s=e.pathname.substring(t+1);return fe[s]}var L={};function Y(r){return`${r==null?void 0:r.method}:${r==null?void 0:r.action}`.trim().toLowerCase()}function ye(r){let e=r.target.closest("form"),t=Y(e);L[t]&&!L[t].has(e)&&r.preventDefault()}document.addEventListener("submit",ye,!0);var S=class{constructor(e){this.controller=e}preventAttachments(){var e,t,s,i,n;(e=this.editor)==null||e.removeAttribute("data-direct-upload-url"),(t=this.editor)==null||t.removeAttribute("data-blob-url-template"),(s=this.editor)==null||s.addEventListener("trix-file-accept",a=>a.preventDefault(),!0),(n=(i=this.toolbar)==null?void 0:i.querySelector('[data-trix-button-group="file-tools"]'))==null||n.remove()}preventLinks(){var e,t;(t=(e=this.toolbar)==null?void 0:e.querySelector('[data-trix-action="link"]'))==null||t.remove()}protect(e=0){if(!this.toolbar&&e<10)return setTimeout(()=>this.protect(e+1),25);if(this.preventAttachments(),this.preventLinks(),!this.form)return;let t=Y(this.form);L[t]=L[t]||new Set,L[t].add(this.form)}get editor(){return this.controller.element}get toolbar(){return this.controller.toolbarElement}get form(){return this.controller.formElement}};var A=class{constructor(e){var t;this.controller=e,this.base=this.obfuscate([location.pathname,(t=this.controller.element.closest("[id]"))==null?void 0:t.id].join("/"))}split(e){let t=Math.ceil(e.length/2);return[e.slice(0,t),e.slice(t)]}obfuscate(e){var i;let t=[...e].map(n=>n.charCodeAt(0));return[(i=this.split(t)[1])==null?void 0:i.reverse(),t[0]].flat().join("")}read(e){return sessionStorage.getItem(this.generateStorageKey(e))}write(e,t){return sessionStorage.setItem(this.generateStorageKey(e),t)}remove(e){return sessionStorage.removeItem(this.generateStorageKey(e))}generateStorageKey(e){let t=[...this.obfuscate(e)],[s,i]=this.split(t);return btoa(`${s}/${this.base}/${i}`)}};var O={link:"<a href='{{url}}'>{{label}}</a>",embedded:`
    <span>
      <strong>{{label}}</strong>
      <small>{{description}}</small>
      <del>{{url}}</del>
    </span>
  `,prohibited:`
    <span>
      <strong>{{label}}</strong>
      <del>{{url}}</del>
    </span>
  `,error:`
    <div data-trix-embed data-trix-embed-error>
      <h1>{{header}}</h1>
      <pre><code>{{error.stack}}</code></pre>
    </div>
  `,iframe:`
    <div data-trix-embed>
      <iframe src='{{src}}' loading='lazy' referrerpolicy='no-referrer' scrolling='no'></iframe>
    </div>
  `,image:`
    <div data-trix-embed>
      <img src='{{src}}' loading='lazy'></img>
    </div>
  `,warning:`
    <div data-trix-embed data-trix-embed-warning>
      <h1>{{header}}</h1>
      <h3>{{subheader}}</h3>

      <h2>{{prohibited.header}}</h2>
      <ul>{{prohibited.hosts}}</ul>

      <h2>{{allowed.header}}</h2>
      <ul>{{allowed.hosts}}</ul>
    </div>
  `};var xe=[G,"a","abbr","acronym","address","b","big","blockquote","br","cite","code","dd","del","dfn","div","dl","dt","em","figcaption","figure","h1","h2","h3","h4","h5","h6","hr","i","iframe","img","ins","kbd","li","ol","p","pre","samp","small","span","strong","sub","sup","time","tt","ul","var"],we=["abbr","allow","allowfullscreen","allowpaymentrequest","alt","caption","cite","content-type","credentialless","csp","data-trix-embed","data-trix-embed-error","data-trix-embed-prohibited","data-trix-embed-warning","datetime","filename","filesize","height","href","lang","loading","name","presentation","previewable","referrerpolicy","sandbox","sgid","src","srcdoc","title","url","width","xml:lang"],R=class{constructor(e){this.controller=e,this.initializeTempates()}sanitize(e){let t=document.createElement("template");t.innerHTML=`<div>${e}</div>`;let s=t.content.firstElementChild;return[s].concat([...s.querySelectorAll("*")]).forEach(n=>{xe.includes(n.tagName.toLowerCase())?[...n.attributes].forEach(a=>{we.includes(a.name.toLowerCase())||n.removeAttribute(a.name)}):n.remove()}),s.innerHTML}initializeTempates(){this.templates=O,Object.keys(O).forEach(e=>this.initializeTemplate(e))}initializeTemplate(e){var n,a;let t=`${e}TemplateValue`,s=this.controller[t],i=s?(a=(n=document.getElementById(s))==null?void 0:n.innerHTML)==null?void 0:a.trim():null;return this.controller[t]=null,i&&(this.templates[e]=i),this.templates[e]}render(e,t={}){return this.templates[e].replace(/{{(.*?)}}/g,(i,n)=>n.split(".").reduce((a,d)=>a[d],t))}renderEmbed(e="https://example.com"){let t=Q(e)?this.render("image",{src:e}):this.render("iframe",{src:e});return this.sanitize(t)}renderEmbeds(e=["https://example.com","https://test.com"]){if(e!=null&&e.length)return e.map(t=>this.renderEmbed(t))}renderWarnings(e=["https://example.com","https://test.com"],t=[]){if(!(e!=null&&e.length))return;let s=D(e).sort();return this.render("warning",{header:"Copy/Paste Warning",subheader:"The pasted content includes media from unsupported hosts.",prohibited:{header:"Prohibited Hosts",hosts:s.length?s.map(i=>`<li>${i}</li>`).join(""):"<li>Media is only supported from allowed hosts.</li>"},allowed:{header:"Allowed Hosts",hosts:t.length?t.map(i=>`<li>${i}</li>`).join(""):"<li>Allowed hosts not configured.</li>"}})}renderError(e){return this.render("error",{header:"Unhandled Exception!",subheader:"Report this problem to a software engineer.",error:e})}};function Z(r={Controller:null,Trix:null}){var s;let{Controller:e,Trix:t}=r;return s=class extends e{connect(){this.setup(),this.onpaste=this.paste.bind(this),this.element.addEventListener("trix-paste",this.onpaste,!0)}disconnect(){this.element.removeEventListener("trix-paste",this.onpaste,!0),this.forgetConfig()}protect(){this.paranoid&&this.guard.protect()}setup(){this.store=new A(this),this.rememberConfig(),this.guard=new S(this),this.protect()}async paste(i){let{html:n,string:a,range:d}=i.paste,m=n||a||"",u=this.createTemplateElement(m),h=J(u);if(!h.length)return;i.preventDefault(),this.editor.setSelectedRange(d);let f=await this.hosts,c=new R(this);try{let o=new Set(h.filter(p=>j(p)));[...u.querySelectorAll("iframe")].forEach(p=>o.add(p.src)),o=[...o];let l=o.filter(p=>N(p,f)),x=o.filter(p=>!l.includes(p)),w=h.filter(p=>!o.includes(p)),K=w.filter(p=>N(p,f)),te=w.filter(p=>!K.includes(p)),P=[...x,...te];if(P.length&&await this.insert(c.renderWarnings(P,f.sort())),l.length&&await this.insert(c.renderEmbeds(l)),h.length===1&&l.length===1)return;let z=this.sanitizePastedElement(u,{renderer:c,validMediaURLs:l,validStandardURLs:K}).innerHTML.trim();z.length&&await this.insert(z,{disposition:"inline"})}catch(o){this.insert(c.renderError(o))}}createTemplateElement(i){let n=document.createElement("template");return n.innerHTML=`<div>${i.trim()}</div>`,n.content.firstElementChild}extractLabelFromElement(i,n={default:null}){let a=i.title;return a&&a.length||(a=i.textContent.trim(),a&&a.length)?a:n.default}sanitizePastedElement(i,n={renderer:null,validMediaURLs:[],validStandardURLs:[]}){let{renderer:a,validMediaURLs:d,validStandardURLs:m}=n;i=i.cloneNode(!0);let u=C(i),h=[],f;for(;f=u.nextNode();)f.replacements=f.replacements||new Set,h.push(f),f.nodeValue.split(/\s+/).filter(g=>g.startsWith("http")).forEach(g=>{var w;let l=(w=b(g))==null?void 0:w.href,x=m.includes(l)||m.includes(l)?a.render("link",{url:l,label:l}):a.render("prohibited",{url:l,label:"Prohibited URL"});f.replacements.add({match:g,replacement:x})});return h.forEach(c=>{if(!c.replacements.size)return;let o=c.nodeValue;[...c.replacements].sort((l,x)=>x.match.length-l.match.length).forEach(l=>o=o.replaceAll(l.match,l.replacement)),c.replaceWith(this.createTemplateElement(o))}),i.querySelectorAll("a").forEach(c=>{let o=k(c),g=this.extractLabelFromElement(c,{default:o}),l=m.includes(o)?a.render("link",{url:o,label:g}):a.render("prohibited",{url:o,label:"Prohibited link"});c.replaceWith(this.createTemplateElement(l))}),i.querySelectorAll(X.join(", ")).forEach(c=>{let o=k(c),g=this.extractLabelFromElement(c,{default:o}),l=d.includes(o)?a.render("embedded",{url:o,label:"Allowed Media",description:"(embedded above)"}):a.render("prohibited",{url:o,label:"Prohibited media"});c.replaceWith(this.createTemplateElement(l))}),i.innerHTML.replaceAll(/(\n|\r|\f|\v)+/g,"<br>"),i}createAttachment(i){return new t.Attachment({content:i,contentType:_.attachment})}insertNewlines(i=1,n={delay:1}){let{delay:a}=n;return new Promise(d=>{setTimeout(()=>{for(let m=0;m<i;m++)this.editor.insertLineBreak();d()},a)})}insertAttachment(i,n={delay:1}){let{delay:a}=n;return new Promise(d=>{setTimeout(()=>{this.editor.insertAttachment(this.createAttachment(i)),this.insertNewlines(1,{delay:a}).finally(d)},a)})}insertHTML(i,n={delay:1}){let{delay:a}=n;return new Promise(d=>{setTimeout(()=>{this.editor.insertHTML(i),this.insertNewlines(1,{delay:a}).finally(d)},a)})}insert(i,n={delay:1,disposition:"attachment"}){let{delay:a,disposition:d}=n;return i!=null&&i.length?new Promise(m=>{setTimeout(()=>{if(typeof i=="string")return d==="inline"?this.insertHTML(i,{delay:a}).catch(u=>this.renderError(u)).finally(m):this.insertAttachment(i,{delay:a}).catch(u=>this.renderError(u)).finally(m);if(Array.isArray(i)){let u=d==="inline"?i.map(h=>this.insertHTML(h,{delay:a+1})):i.map(h=>this.insertAttachment(h,{delay:a+1}));return Promise.all(u).catch(h=>this.renderError(h)).finally(m)}m()})}):Promise.resolve()}get editor(){return this.element.editor}get toolbarElement(){let i=this.element.getAttribute("toolbar"),n=i?document.getElementById(i):null;if(!n){let a=this.element.previousElementSibling;n=a!=null&&a.tagName.match(/trix-toolbar/i)?a:null}return n}get inputElement(){var n;let i=this.element.getAttribute("input");return i?((n=this.formElement)==null?void 0:n.querySelector(`#${i}`))||document.getElementById(i):null}get formElement(){return this.element.closest("form")}get paranoid(){return!!this.store.read("paranoid")}get key(){try{return JSON.parse(this.store.read("key"))[2]}catch(i){}}get hosts(){try{return F(this.key,JSON.parse(this.store.read("hosts")))}catch(i){return[]}}get reservedDomains(){return["embed.example","embed.invalid","embed.local","embed.localhost","embed.test","trix.embed.example","trix.embed.invalid","trix.embed.local","trix.embed.localhost","trix.embed.test","trix.example","trix.invalid","trix.local","trix.localhost","trix.test","www.embed.example","www.embed.invalid","www.embed.local","www.embed.localhost","www.embed.test","www.trix.example","www.trix.invalid","www.trix.local","www.trix.localhost","www.trix.test"]}async rememberConfig(){let i=await E(),n=new Set;for(;n.size<3;)n.add(this.reservedDomains[Math.floor(Math.random()*this.reservedDomains.length)]);n=await y(i,[...n]);let a=await y(i,this.hostsValue);this.store.write("key",JSON.stringify([n[0],n[1],i,n[2]])),this.element.removeAttribute("data-trix-embed-key-value"),this.store.write("hosts",JSON.stringify(a)),this.element.removeAttribute("data-trix-embed-hosts-value"),this.paranoidValue!==!1&&(this.store.write("paranoid",JSON.stringify(n.slice(3))),this.element.removeAttribute("data-trix-embed-paranoid"))}forgetConfig(){var i,n,a;(i=this.store)==null||i.remove("key"),(n=this.store)==null||n.remove("hosts"),(a=this.store)==null||a.remove("paranoid")}},V(s,"values",{embeddedTemplate:String,errorTemplate:String,iframeTemplate:String,imageTemplate:String,linkTemplate:String,prohibitedTemplate:String,warningTemplate:String,hosts:Array,paranoid:{type:Boolean,default:!0}}),s}var ee=!1,ve={application:null,Controller:null,Trix:null};function Te(r=ve){if(ee)return;let{application:e,Controller:t,Trix:s}=r;e.register("trix-embed",Z({Controller:t,Trix:s})),ee=!0}self.TrixEmbed=T(v({},W),{encryptValues:y,generateKey:E,generateKeyAndEncryptValues:$,initialize:Te});var et=self.TrixEmbed;export{et as default};
