/*
  trix-embed 0.0.2 (MIT)
  Copyright Â© 2023 Nate Hopkins (hopsoft) <natehop@gmail.com>
*/
var te=Object.defineProperty,re=Object.defineProperties;var ie=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var ne=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable;var C=(i,e,t)=>e in i?te(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,v=(i,e)=>{for(var t in e||(e={}))ne.call(e,t)&&C(i,t,e[t]);if(I)for(var t of I(e))ae.call(e,t)&&C(i,t,e[t]);return i},E=(i,e)=>re(i,ie(e));var R=(i,e,t)=>(C(i,typeof e!="symbol"?e+"":e,t),t);var W={author:"Nate Hopkins (hopsoft) <natehop@gmail.com>",copyright:"Copyright \xA9 2023 Nate Hopkins (hopsoft) <natehop@gmail.com>",description:"A Stimulus controller to safely embed external media in the Trix editor",license:"MIT",repository:"https://github.com/hopsoft/trix_embed",version:"0.0.2"};var U={name:"AES-GCM",length:256},oe=!0,se=["encrypt","decrypt"];async function le(){let e=["encrypt","decrypt"];return await crypto.subtle.generateKey(U,!0,e)}async function ce(i){let e=await crypto.subtle.exportKey("jwk",i);return JSON.stringify(e)}async function F(i){let e=JSON.parse(i);return await crypto.subtle.importKey("jwk",e,U,oe,se)}async function de(i,e){let t=new TextEncoder().encode(String(i)),n=crypto.getRandomValues(new Uint8Array(12)),r=await crypto.subtle.encrypt(E(v({},U),{iv:n}),e,t),a={ciphertext:btoa(String.fromCharCode(...new Uint8Array(r))),iv:btoa(String.fromCharCode(...n))};return btoa(JSON.stringify(a))}async function me(i,e){let t=JSON.parse(atob(i)),n=new Uint8Array(atob(t.ciphertext).split("").map(o=>o.charCodeAt(0))),r=new Uint8Array(atob(t.iv).split("").map(o=>o.charCodeAt(0))),a=await crypto.subtle.decrypt(E(v({},U),{iv:r}),e,n);return new TextDecoder().decode(a)}async function T(){let i=await le(),e=await ce(i);return btoa(e)}async function y(i,e=[]){let t=await F(atob(i));return Promise.all(e.map(n=>de(n,t)))}async function $(i,e=[]){let t=await F(atob(i));return Promise.all(e.map(n=>me(n,t)))}async function D(i=[]){let e=await T(),t=await y(e,i);return console.log(`data-trix-embed-key-value="${e}"`),console.log(`data-trix-embed-hosts-value='${JSON.stringify(t)}'`),{key:e,encryptedValues:t}}function b(i,e=t=>{}){try{let t=new URL(String(i).trim());return t&&e&&e(t),t}catch(t){console.info(`Failed to parse URL! value='${i}']`)}return null}function q(i,e=t=>{}){var n;let t=(n=b(i))==null?void 0:n.host;return t&&e&&e(t),t}function O(i){return document.createTreeWalker(i,NodeFilter.SHOW_TEXT,e=>e.nodeValue.match(/http/gi)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP)}function he(i){let e=new Set,t=O(i),n;for(;n=t.nextNode();)n.nodeValue.split(/\s+/).filter(r=>r.startsWith("http")).forEach(r=>b(r,a=>e.add(a.href)));return[...e]}function N(i){if(i.src){let e=i.src.trim();if(e.length)return e}if(i.href){let e=i.href.trim();if(e.length)return e}return""}function pe(i){let e=new Set;return i.src&&b(i.src,n=>e.add(n.href)),i.href&&b(i.href,n=>e.add(n.href)),i.querySelectorAll("[src], [href]").forEach(n=>b(N(n),r=>e.add(r.href))),[...e]}function j(i,e=[]){let t=q(i);return t?!!e.find(n=>t.includes(n)):!1}function J(i){return[...i.reduce((e,t)=>(q(t,n=>e.add(n)),e),new Set)]}function _(i){let e=pe(i),t=he(i);return[...new Set([...e,...t])]}var M={attachment:"trix-embed/attachment"};var B={avif:"image/avif",bmp:"image/bmp",gif:"image/gif",heic:"image/heic",heif:"image/heif",ico:"image/x-icon",jp2:"image/jp2",jpeg:"image/jpeg",jpg:"image/jpeg",jxr:"image/vnd.ms-photo",png:"image/png",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",webp:"image/webp"};var ue=B,fe=["animate","animateMotion","animateTransform","area","audio","base","embed","feDisplacementMap","feImage","feTile","filter","font-face-uri","iframe","image","link","object","script","source","track","use","video"],ge=["audio","embed","iframe","img","input","script","source","track","video","frame","frameset","object","picture","use"],G="action-text-attachment",X=fe.concat(ge);function Q(i){return!!Object.values(B).find(e=>e===H(i))}function H(i){let e;if(e=b(i),!e)return null;let t=e.pathname.lastIndexOf(".");if(!t)return null;let n=e.pathname.substring(t+1);return ue[n]}var K={},L=class{constructor(e){R(this,"protectSubmit",e=>{let t=this.controller.formElement,n=e.target.closest("form");n&&n.action===t.action&&n.method===t.method&&n!==t&&e.preventDefault()});this.controller=e}preventAttachments(){var e;(e=this.controller.toolbarElement.querySelector('[data-trix-button-group="file-tools"]'))==null||e.remove(),this.controller.element.removeAttribute("data-direct-upload-url"),this.controller.element.removeAttribute("data-blob-url-template"),this.controller.element.addEventListener("trix-file-accept",t=>t.preventDefault())}preventLinks(){var e;(e=this.controller.toolbarElement.querySelector('[data-trix-action="link"]'))==null||e.remove()}protect(){if(this.preventAttachments(),this.preventLinks(),!this.controller.formElement)return;let e=this.controller.formElement,t=this.controller.inputElement,n=`${e.method}${e.action}`;document.removeEventListener("submit",K[n],!0),K[n]=this.protectSubmit.bind(this),document.addEventListener("submit",K[n],!0),new MutationObserver((a,o)=>{a.forEach(m=>{let{addedNodes:d,target:h,type:p}=m;switch(p){case"attributes":let u=node.closest("form");e!=null&&e.action&&e.action===(u==null?void 0:u.action)&&(h.id===t.id||h.name===t.name)&&h.remove();break;case"childList":d.forEach(l=>{if(l.nodeType===Node.ELEMENT_NODE){let s=l.closest("form");e!=null&&e.action&&e.action===(s==null?void 0:s.action)?s!==e&&l.remove():t!=null&&t.name&&t.name===(l==null?void 0:l.name)&&l.remove()}});break}})}).observe(document.body,{attributeFilter:["id","name"],attributes:!0,childList:!0,subtree:!0})}cleanup(){let e=this.controller.element,t=this.controller.inputElement,n=this.controller.toolbarElement;t==null||t.remove(),n==null||n.remove(),e==null||e.remove()}};var A=class{constructor(e){var t;this.controller=e,this.base=this.obfuscate([location.pathname,(t=this.controller.element.closest("[id]"))==null?void 0:t.id].join("/"))}split(e){let t=Math.ceil(e.length/2);return[e.slice(0,t),e.slice(t)]}obfuscate(e){var r;let t=[...e].map(a=>a.charCodeAt(0));return[(r=this.split(t)[1])==null?void 0:r.reverse(),t[0]].flat().join("")}read(e){return sessionStorage.getItem(this.generateStorageKey(e))}write(e,t){return sessionStorage.setItem(this.generateStorageKey(e),t)}remove(e){return sessionStorage.removeItem(this.generateStorageKey(e))}generateStorageKey(e){let t=[...this.obfuscate(e)],[n,r]=this.split(t);return btoa(`${n}/${this.base}/${r}`)}};var V={anchor:"<a href='{{href}}'>{{content}}</a>",error:`
    <div data-trix-embed data-trix-embed-error>
      <h1>{{header}}</h1>
      <pre><code>{{error.stack}}</code></pre>
    </div>
  `,iframe:`
    <div data-trix-embed>
      <iframe src='{{src}}' loading='lazy' referrerpolicy='no-referrer' scrolling='no'></iframe>
    </div>
  `,image:`
    <div data-trix-embed>
      <img src='{{src}}' loading='lazy'></img>
    </div>
  `,prohibited:`
    <div data-trix-embed data-trix-embed-prohibited='{{detail.type}}: {{detail.url}}'>
      <del>{{content}}</del>
    </div>
  `,warning:`
    <div data-trix-embed data-trix-embed-warning>
      <h1>{{header}}</h1>
      <h3>{{subheader}}</h3>

      <h2>{{prohibited.header}}</h2>
      <ul>{{prohibited.hosts}}</ul>

      <h2>{{allowed.header}}</h2>
      <ul>{{allowed.hosts}}</ul>
    </div>
  `};var be=[G,"a","abbr","acronym","address","b","big","blockquote","br","cite","code","dd","del","dfn","div","dl","dt","em","figcaption","figure","h1","h2","h3","h4","h5","h6","hr","i","iframe","img","ins","kbd","li","ol","p","pre","samp","small","span","strong","sub","sup","time","tt","ul","var"],ye=["abbr","allow","allowfullscreen","allowpaymentrequest","alt","caption","cite","content-type","credentialless","csp","data-trix-embed","data-trix-embed-error","data-trix-embed-prohibited","data-trix-embed-warning","datetime","filename","filesize","height","href","lang","loading","name","presentation","previewable","referrerpolicy","sandbox","sgid","src","srcdoc","title","url","width","xml:lang"],S=class{constructor(e){this.controller=e,this.initializeTempates()}sanitize(e){let t=document.createElement("template");t.innerHTML=`<div>${e}</div>`;let n=t.content.firstElementChild;return[n].concat([...n.querySelectorAll("*")]).forEach(a=>{be.includes(a.tagName.toLowerCase())?[...a.attributes].forEach(o=>{ye.includes(o.name.toLowerCase())||a.removeAttribute(o.name)}):a.remove()}),n.innerHTML}initializeTempates(){this.templates=V,Object.keys(V).forEach(e=>this.initializeTemplate(e))}initializeTemplate(e){var a,o;let t=`${e}TemplateValue`,n=this.controller[t],r=n?(o=(a=document.getElementById(n))==null?void 0:a.innerHTML)==null?void 0:o.trim():null;return this.controller[t]=null,r&&(this.templates[e]=r),this.templates[e]}render(e,t={}){return this.templates[e].replace(/{{(.*?)}}/g,(r,a)=>a.split(".").reduce((o,m)=>o[m],t))}renderTrixAttachment(e){let t=new Trix.Attachment({content:e,contentType:M.attachment}),n=new Trix.AttachmentPiece(t),r=new Trix.AttachmentView(t,{piece:n}),a=Trix.makeElement({tagName:"figure",className:r.getClassName(),data:r.getData(),editable:!1});return a.innerHTML=t.getContent(),a.outerHTML}renderEmbed(e="https://example.com"){let t=Q(e)?this.render("image",{src:e}):this.render("iframe",{src:e});return this.sanitize(t)}renderWarnings(e=["https://example.com","https://test.com"],t=[]){if(!(e!=null&&e.length))return;let n=J(e).sort();return this.render("warning",{header:"Copy/Paste Warning",subheader:"The pasted content includes media from unsupported hosts.",prohibited:{header:"Prohibited Hosts",hosts:n.length?n.map(r=>`<li>${r}</li>`).join(""):"<li>Media is only supported from allowed hosts.</li>"},allowed:{header:"Allowed Hosts",hosts:t.length?t.map(r=>`<li>${r}</li>`).join(""):"<li>Allowed hosts not configured.</li>"}})}renderError(e){return this.render("error",{header:"Unhandled Exception!",subheader:"Report this problem to a software engineer.",error:e})}};var xe={Controller:null,Trix:null};function Y(i=xe){var n;let{Controller:e,Trix:t}=i;return n=class extends e{async connect(){this.guard=new L(this),this.paranoidValue&&this.guard.protect(),this.store=new A(this),await this.rememberConfig(),this.onpaste=this.paste.bind(this),this.element.addEventListener("trix-paste",this.onpaste,!0),window.addEventListener("beforeunload",()=>this.disconnect())}disconnect(){this.element.removeEventListener("trix-paste",this.onpaste,!0),this.paranoid&&this.guard.cleanup(),this.forgetConfig()}async paste(r){let{html:a,string:o,range:m}=r.paste,d=a||o||"",h=this.createTemplateElement(d),p=_(h);if(!p.length)return;r.preventDefault(),this.editor.setSelectedRange(m);let u=await this.hosts,l=new S(this);try{let s=new Set(p.filter(f=>H(f)));[...h.querySelectorAll("iframe")].forEach(f=>s.add(f.src)),s=[...s];let c=s.filter(f=>j(f,u)),x=s.filter(f=>!c.includes(f)),w=p.filter(f=>!s.includes(f)),z=w.filter(f=>j(f,u)),ee=w.filter(f=>!z.includes(f)),k;k=[...x,...ee],k.length&&await this.insert(l.renderWarnings(k,u.sort()));let P=this.sanitizePastedElement(h,{renderer:l,validMediaURLs:c,validStandardURLs:z}).innerHTML.trim();P.length&&await this.insert(P,{disposition:"inline"})}catch(s){this.insert(l.renderError(s))}}createTemplateElement(r){let a=document.createElement("template");return a.innerHTML=`<div>${r.trim()}</div>`,a.content.firstElementChild}extractLabelFromElement(r,a={default:null}){let o=r.title;return o&&o.length||(o=r.textContent.trim(),o&&o.length)?o:a.default}sanitizePastedElement(r,a={renderer:null,validMediaURLs:[],validStandardURLs:[]}){let{renderer:o,validMediaURLs:m,validStandardURLs:d}=a;r=r.cloneNode(!0);let h=O(r),p=[],u;for(;u=h.nextNode();)u.replacements=u.replacements||new Set,p.push(u),u.nodeValue.split(/\s+/).filter(g=>g.startsWith("http")).forEach(g=>{var w;let c=(w=b(g))==null?void 0:w.href,x=d.includes(c)||d.includes(c)?o.render("anchor",{href:c,content:c}):o.renderTrixAttachment(o.render("prohibited",{content:c,detail:{url:c,type:"URL"}}));u.replacements.add({match:g,replacement:x})});return p.forEach(l=>{if(!l.replacements.size)return;let s=l.nodeValue;[...l.replacements].sort((c,x)=>x.match.length-c.match.length).forEach(c=>s=s.replaceAll(c.match,c.replacement)),l.replaceWith(this.createTemplateElement(s))}),r.querySelectorAll("a").forEach(l=>{let s=N(l),g=this.extractLabelFromElement(l,{default:s}),c=d.includes(s)?o.render("anchor",{href:s,content:g}):o.renderTrixAttachment(o.render("prohibited",{content:g,detail:{url:s,type:"LINK"}}));l.replaceWith(this.createTemplateElement(c))}),r.querySelectorAll(X.join(", ")).forEach(l=>{let s=N(l),g=this.extractLabelFromElement(l,{default:s}),c=m.includes(s)?o.renderTrixAttachment(o.renderEmbed(s)):o.renderTrixAttachment(o.render("prohibited",{content:g,detail:{url:s,type:"MEDIA"}}));l.replaceWith(this.createTemplateElement(c))}),r.innerHTML.replaceAll(/(\n|\r|\f|\v)+/g,"<br>"),r}insertNewlines(r=1,a={delay:1}){let{delay:o}=a;return new Promise(m=>{setTimeout(()=>{for(let d=0;d<r;d++)this.editor.insertLineBreak();m()},o)})}insertAttachment(r,a={delay:1}){let{delay:o}=a;return new Promise(m=>{setTimeout(()=>{let d=new t.Attachment({content:r,contentType:M.attachment});this.editor.insertAttachment(d),this.insertNewlines(1,{delay:o*5}).then(m)},o)})}insertHTML(r,a={delay:1}){let{delay:o}=a;return new Promise(m=>{setTimeout(()=>{this.editor.insertHTML(r),this.insertNewlines(1,{delay:o*5}).then(m)},o)})}insert(r,a={delay:1,disposition:"attachment"}){let{delay:o,disposition:m}=a;return r!=null&&r.length?new Promise(d=>{setTimeout(()=>{if(typeof r=="string")return m==="inline"?this.insertHTML(r,{delay:o}).catch(h=>this.renderError(h)).finally(d):this.insertAttachment(r,{delay:o}).catch(h=>this.renderError(h)).finally(d);if(Array.isArray(r)){let h=m==="inline"?r.map(p=>this.insertHTML(p,{delay:o*=1.15})):r.map(p=>this.insertAttachment(p,{delay:o*=1.15}));return Promise.all(h).catch(p=>this.renderError(p)).finally(d)}d()})}):Promise.resolve()}get editor(){return this.element.editor}get toolbarElement(){let r=this.element.previousElementSibling;return r!=null&&r.tagName.match(/trix-toolbar/i)?r:null}get inputElement(){var r;return((r=this.formElement)==null?void 0:r.querySelector(`#${this.element.getAttribute("input")}`))||document.getElementById(this.element.getAttribute("input"))}get formElement(){return this.element.closest("form")}get paranoid(){return!!this.store.read("paranoid")}get key(){try{return JSON.parse(this.store.read("key"))[2]}catch(r){}}get hosts(){try{return $(this.key,JSON.parse(this.store.read("hosts")))}catch(r){return[]}}get reservedDomains(){return["embed.example","embed.invalid","embed.local","embed.localhost","embed.test","trix.embed.example","trix.embed.invalid","trix.embed.local","trix.embed.localhost","trix.embed.test","trix.example","trix.invalid","trix.local","trix.localhost","trix.test","www.embed.example","www.embed.invalid","www.embed.local","www.embed.localhost","www.embed.test","www.trix.example","www.trix.invalid","www.trix.local","www.trix.localhost","www.trix.test"]}async rememberConfig(){let r=await T(),a=new Set;for(;a.size<3;)a.add(this.reservedDomains[Math.floor(Math.random()*this.reservedDomains.length)]);a=await y(r,[...a]);let o=await y(r,this.hostsValue);this.store.write("key",JSON.stringify([a[0],a[1],r,a[2]])),this.element.removeAttribute("data-trix-embed-key-value"),this.store.write("hosts",JSON.stringify(o)),this.element.removeAttribute("data-trix-embed-hosts-value"),this.paranoidValue!==!1&&(this.store.write("paranoid",JSON.stringify(a.slice(3))),this.element.removeAttribute("data-trix-embed-paranoid"))}forgetConfig(){this.store.remove("key"),this.store.remove("hosts"),this.store.remove("paranoid")}},R(n,"values",{warningTemplate:String,iframeTemplate:String,imageTemplate:String,hosts:Array,paranoid:{type:Boolean,default:!0}}),n}var Z=!1,we={application:null,Controller:null,Trix:null};function ve(i=we){if(Z)return;let{application:e,Controller:t,Trix:n}=i;e.register("trix-embed",Y({Controller:t,Trix:n})),Z=!0}self.TrixEmbed=E(v({},W),{encryptValues:y,generateKey:T,generateKeyAndEncryptValues:D,initialize:ve});var Ze=self.TrixEmbed;export{Ze as default};
