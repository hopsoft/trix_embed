var z=Object.defineProperty,B=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var k=Object.getOwnPropertySymbols;var _=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable;var S=(r,e,t)=>e in r?z(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,A=(r,e)=>{for(var t in e||(e={}))_.call(e,t)&&S(r,t,e[t]);if(k)for(var t of k(e))G.call(e,t)&&S(r,t,e[t]);return r},M=(r,e)=>B(r,W(e));var C=(r,e,t)=>(S(r,typeof e!="symbol"?e+"":e,t),t);var E={name:"AES-GCM",length:256},X=!0,Q=["encrypt","decrypt"];async function Y(){let e=["encrypt","decrypt"];return await crypto.subtle.generateKey(E,!0,e)}async function Z(r){let e=await crypto.subtle.exportKey("jwk",r);return JSON.stringify(e)}async function H(r){let e=JSON.parse(r);return await crypto.subtle.importKey("jwk",e,E,X,Q)}async function ee(r,e){let t=new TextEncoder().encode(String(r)),i=crypto.getRandomValues(new Uint8Array(12)),n=await crypto.subtle.encrypt(M(A({},E),{iv:i}),e,t),s={ciphertext:btoa(String.fromCharCode(...new Uint8Array(n))),iv:btoa(String.fromCharCode(...i))};return btoa(JSON.stringify(s))}async function te(r,e){let t=JSON.parse(atob(r)),i=new Uint8Array(atob(t.ciphertext).split("").map(a=>a.charCodeAt(0))),n=new Uint8Array(atob(t.iv).split("").map(a=>a.charCodeAt(0))),s=await crypto.subtle.decrypt(M(A({},E),{iv:n}),e,i);return new TextDecoder().decode(s)}async function g(){let r=await Y(),e=await Z(r);return btoa(e)}async function p(r,e=[]){let t=await H(atob(r));return Promise.all(e.map(i=>ee(i,t)))}async function j(r,e=[]){let t=await H(atob(r));return Promise.all(e.map(i=>te(i,t)))}async function P(r=[]){let e=await g(),t=await p(e,r);return console.log(`data-trix-embed-key-value="${e}"`),console.log(`data-trix-embed-hosts-value='${JSON.stringify(t)}'`),{key:e,encryptedValues:t}}function d(r,e=t=>{}){try{let t=new URL(String(r).trim());return e&&e(t),t}catch(t){console.info(`Failed to parse URL! value='${r}']`)}return null}function K(r,e=t=>{}){let t=null;return d(r,i=>t=i.host),t&&e&&e(t),t}function re(r){let e=[],t=document.createTreeWalker(r,NodeFilter.SHOW_TEXT,n=>n.nodeValue.includes("http")?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT),i;for(;i=t.nextNode();)i.nodeValue.split(/\s+/).filter(n=>n.startsWith("http")).forEach(n=>d(n,s=>{e.includes(s.href)||e.push(s.href)}));return e}function ie(r){let e=[];return r.src&&d(r.src,i=>e.push(i.href)),r.href&&d(r.href,i=>{e.includes(i.href)||e.push(i.href)}),r.querySelectorAll("[src], [href]").forEach(i=>{d(i.src||i.href,n=>{e.includes(n.href)||e.push(n.href)})}),e}function R(r,e=[]){let t=!1;return K(r,i=>t=!!e.find(n=>i.includes(n))),t}function O(r){return r.reduce((e,t)=>(K(t,i=>{e.includes(i)||e.push(i)}),e),[])}function V(r){let e=ie(r),t=re(r);return[...new Set([...e,...t])]}var $={avif:"image/avif",bmp:"image/bmp",gif:"image/gif",heic:"image/heic",heif:"image/heif",ico:"image/x-icon",jp2:"image/jp2",jpeg:"image/jpeg",jpg:"image/jpeg",jxr:"image/vnd.ms-photo",png:"image/png",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",webp:"image/webp"};var ne=$,se=["animate","animateMotion","animateTransform","area","audio","base","embed","feDisplacementMap","feImage","feTile","filter","font-face-uri","iframe","image","link","object","script","source","track","use","video"],oe=["audio","embed","iframe","img","input","script","source","track","video","frame","frameset","object","picture","use"],I=se.concat(oe);function q(r){return!!Object.values($).find(e=>e===U(r))}function U(r){let e;if(d(r,n=>e=n),!e)return null;let t=e.pathname.lastIndexOf(".");if(!t)return null;let i=e.pathname.substring(t+1);return ne[i]}var y=class{constructor(e){this.controller=e,e.element.addEventListener("trix-file-accept",t=>t.preventDefault())}protect(){if(!this.controller.formElement)return;let e=this.controller.formElement,t=this.controller.inputElement;new MutationObserver((n,s)=>{n.forEach(a=>{var f;let{addedNodes:T,target:m,type:h}=a;switch(h){case"attributes":((f=m.closest("form"))==null?void 0:f.action)===e.action&&(m.id===t.id||m.name===t.name)&&m.remove();break;case"childList":T.forEach(o=>{var u;o.nodeType===Node.ELEMENT_NODE&&(o.tagName.match(/^form$/i)&&o.action===e.action&&o.remove(),((u=m.closest("form"))==null?void 0:u.action)===e.action&&(o.id===t.id||o.name===t.name)&&o.remove())});break}})}).observe(document.body,{attributeFilter:["id","name"],attributes:!0,childList:!0,subtree:!0})}cleanup(){let e=this.controller.element,t=this.controller.inputElement,i=this.controller.toolbarElement;t==null||t.remove(),i==null||i.remove(),e==null||e.remove()}};var b=class{constructor(e){var t;this.controller=e,this.base=this.obfuscate([location.pathname,(t=this.controller.element.closest("[id]"))==null?void 0:t.id].join("/"))}split(e){let t=Math.ceil(e.length/2);return[e.slice(0,t),e.slice(t)]}obfuscate(e){var n;let t=[...e].map(s=>s.charCodeAt(0));return[(n=this.split(t)[1])==null?void 0:n.reverse(),t[0]].flat().join("")}read(e){return sessionStorage.getItem(this.generateStorageKey(e))}write(e,t){return sessionStorage.setItem(this.generateStorageKey(e),t)}remove(e){return sessionStorage.removeItem(this.generateStorageKey(e))}generateStorageKey(e){let t=[...this.obfuscate(e)],[i,n]=this.split(t);return btoa(`${i}/${this.base}/${n}`)}};var ae={header:"<h1></h1>",iframe:"<iframe></iframe>",image:"<img></img>",error:`
    <div>
      <h1>Copy / Paste</h1>
      <h3>The pasted content includes media from unsupported hosts / domains.</h3>

      <h2>Prohibited Hosts / Domains</h2>
      <ul data-list="hosts"></ul>

      <h2>Allowed Hosts / Domains</h2>
      <ul data-list="allowed-hosts"></ul>
    </div>
  `};function D(r){let e=document.createElement("template");return e.innerHTML=ae[r],e}var v=class{constructor(e){this.controller=e,this.hosts=this.controller.hostsValue,this.initializeTempates()}initializeTempates(){["error","header","iframe","image"].forEach(t=>this.initializeTemplate(t))}initializeTemplate(e){let t;this.controller[`has${e.charAt(0).toUpperCase()+e.slice(1)}TemplateValue`]&&(t=document.getElementById(this.controller[`${e}TemplateValue`])),this[`${e}Template`]=t||D(e)}renderHeader(e){let t=this.headerTemplate.content.firstElementChild.cloneNode(!0),i=t.tagName.match(/h1/i)?t:t.querySelector("h1");return i.innerHTML=e,t.outerHTML}renderLinks(e=["https://example.com","https://test.com"]){return e=e.filter(i=>{let n=!1;return d(i,s=>n=!0),n}).sort(),e.length?`<ul>${e.map(i=>`<li><a href='${i}'>${i}</a></li>`).join("")}</ul><br>`:void 0}renderEmbed(e="https://example.com"){let t;if(q(e)){t=this.imageTemplate.content.firstElementChild.cloneNode(!0);let i=t.tagName.match(/img/i)?t:t.querySelector("img");i.src=e}else{t=this.iframeTemplate.content.firstElementChild.cloneNode(!0);let i=t.tagName.match(/iframe/i)?t:t.querySelector("iframe");i.src=e}return t.outerHTML}renderEmbeds(e=["https://example.com","https://test.com"]){if(e!=null&&e.length)return e.map(t=>this.renderEmbed(t))}renderErrors(e=["https://example.com","https://test.com"]){if(!(e!=null&&e.length))return;let t=this.errorTemplate.content.firstElementChild.cloneNode(!0),i=t.querySelector('[data-list="allowed-hosts"]'),n=t.querySelector('[data-list="hosts"]');if(i&&(this.hosts.length?i.innerHTML=this.hosts.map(s=>`<li><code>${s}</code></li>`).join(""):i.innerHTML=`
          <li>
            <strong>Allowed hosts not configured yet.</strong>
          </li>
        `),n){let s=O(e);s.length?n.innerHTML=s.map(a=>`<li><code>${a}</code></li>`).join(""):n.innerHTML="<li><code>Media is only supported from allowed hosts.</code></li>"}return t.outerHTML}};import{Controller as ce}from"https://unpkg.com/@hotwired/stimulus@3.2.1/dist/stimulus.js";var x=class extends ce{async connect(){var r;this.store=new b(this),this.guard=new y(this),await this.rememberConfig(),this.paranoid&&this.guard.protect(),(r=this.toolbarElement.querySelector('[data-trix-button-group="file-tools"]'))==null||r.remove(),window.addEventListener("beforeunload",()=>this.disconnect())}disconnect(){this.paranoid&&this.guard.cleanup(),this.forgetConfig()}async paste(r){let{html:e,string:t,range:i}=r.paste,n=e||t||"",s=this.buildPastedTemplate(n),a=s.content.firstElementChild,m=this.sanitizePastedElement(a).innerHTML.trim(),h=V(a);if(!h.length)return;r.preventDefault(),this.editor.setSelectedRange(i);let f=await this.hosts,o=new v(this),u=h.filter(c=>U(c));Array.from(s.content.firstElementChild.querySelectorAll("iframe")).forEach(c=>{u.includes(c.src)||u.push(c.src)});let L=u.filter(c=>R(c,f)),F=u.filter(c=>!L.includes(c)),N=h.filter(c=>!u.includes(c)),w=N.filter(c=>R(c,f)),J=N.filter(c=>!w.includes(c)),l;l=F,l.length&&await this.insert(o.renderErrors(l)),l=J,l.length&&(await this.insert(o.renderHeader("Pasted URLs")),await this.insert(o.renderLinks(l),{disposition:"inline"})),l=L,l.length&&(l.length>1&&await this.insert(o.renderHeader("Embedded Media")),await this.insert(o.renderEmbeds(l))),l=w,l.length&&await this.insert(o.renderEmbeds(w)),!(h.length===1||L[0]===m)&&(h.length===1||w[0]===m||m.length&&(await this.insert(o.renderHeader("Pasted Content",m)),this.editor.insertLineBreak(),this.insert(m,{disposition:"inline"})))}buildPastedTemplate(r){let e=document.createElement("template");return e.innerHTML=`<div>${r.trim()}</div>`,e}sanitizePastedElement(r){return r=r.cloneNode(!0),r.querySelectorAll(I.join(", ")).forEach(e=>e.remove()),r}insertAttachment(r,e={delay:0}){let{delay:t}=e;return new Promise(i=>{setTimeout(()=>{let n=new Trix.Attachment({content:r,contentType:"application/vnd.trix-embed.html"});this.editor.insertAttachment(n),i()},t)})}insertHTML(r,e={delay:0}){let{delay:t}=e;return new Promise(i=>{setTimeout(()=>{this.editor.insertHTML(r),this.editor.moveCursorInDirection("forward"),this.editor.insertLineBreak(),this.editor.moveCursorInDirection("backward"),i()},t)})}insert(r,e={delay:0,disposition:"attachment"}){let{delay:t,disposition:i}=e;return r!=null&&r.length?new Promise(n=>{setTimeout(()=>{if(typeof r=="string")return i==="inline"?this.insertHTML(r,{delay:t}).then(n):this.insertAttachment(r,{delay:t}).then(n);if(Array.isArray(r))return i==="inline"?r.reduce((s,a,T)=>s.then(this.insertHTML(a,{delay:t})),Promise.resolve()).then(n):r.reduce((s,a,T)=>s.then(this.insertAttachment(a,{delay:t})),Promise.resolve()).then(n);n()})}):Promise.resolve()}get editor(){return this.element.editor}get toolbarElement(){let r=this.element.previousElementSibling;return r!=null&&r.tagName.match(/trix-toolbar/i)?r:null}get inputElement(){return document.getElementById(this.element.getAttribute("input"))}get formElement(){return this.element.closest("form")}get paranoid(){return!!this.store.read("paranoid")}get key(){try{return JSON.parse(this.store.read("key"))[2]}catch(r){}}get hosts(){try{return j(this.key,JSON.parse(this.store.read("hosts")))}catch(r){return[]}}get reservedDomains(){return["example.com","test.com","invalid.com","example.cat","nic.example","example.co.uk"]}async rememberConfig(){let r=await g(),e=await p(r,this.reservedDomains),t=await p(r,this.hostsValue);this.store.write("key",JSON.stringify([e[0],e[1],r,e[2]])),this.element.removeAttribute("data-trix-embed-key-value"),this.store.write("hosts",JSON.stringify(t)),this.element.removeAttribute("data-trix-embed-hosts-value"),this.paranoidValue!==!1&&(this.store.write("paranoid",JSON.stringify(e.slice(3))),this.element.removeAttribute("data-trix-embed-paranoid"))}forgetConfig(){this.store.remove("key"),this.store.remove("hosts"),this.store.remove("paranoid")}};C(x,"values",{validTemplate:String,errorTemplate:String,headerTemplate:String,iframeTemplate:String,imageTemplate:String,hosts:Array,paranoid:{type:Boolean,default:!0}});var le={application:null};function me(r=le){let{application:e}=r;e.register("trix-embed",x)}self.TrixEmbed={initialize:me,generateKey:g,encryptValues:p,generateKeyAndEncryptValues:P};var Oe=self.TrixEmbed;export{Oe as default};
