var j=Object.defineProperty;var A=(i,e,t)=>e in i?j(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var M=(i,e,t)=>(A(i,typeof e!="symbol"?e+"":e,t),t);function m(i,e=t=>{}){try{let t=new URL(String(i).trim());return e&&e(t),t}catch(t){console.info("trix-embed",`Failed to parse URL! value='${i}']`)}return null}function b(i,e=t=>{}){let t=null;return m(i,r=>t=r.host),t&&e&&e(t),t}function V(i){let e=[],t=document.createTreeWalker(i,NodeFilter.SHOW_TEXT,s=>s.nodeValue.includes("http")?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT),r;for(;r=t.nextNode();)r.nodeValue.split(/\s+/).filter(s=>s.startsWith("http")).forEach(s=>m(s,n=>{e.includes(n.href)||e.push(n.href)}));return e}function P(i){let e=[];return i.src&&m(i.src,r=>e.push(r.href)),i.href&&m(i.href,r=>{e.includes(r.href)||e.push(r.href)}),i.querySelectorAll("[src], [href]").forEach(r=>{m(r.src||r.href,s=>{e.includes(s.href)||e.push(s.href)})}),e}function f(i,e=[]){let t=!1;return b(i,r=>t=!!e.find(s=>r.includes(s))),t}function R(i){return i.reduce((e,t)=>(b(t,r=>{e.includes(r)||e.push(r)}),e),[])}function H(i){let e=P(i),t=V(i);return[...new Set([...e,...t])]}var I={avif:"image/avif",bmp:"image/bmp",gif:"image/gif",heic:"image/heic",heif:"image/heif",ico:"image/x-icon",jp2:"image/jp2",jpeg:"image/jpeg",jpg:"image/jpeg",jxr:"image/vnd.ms-photo",png:"image/png",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",webp:"image/webp"};var F=I,N=["animate","animateMotion","animateTransform","area","audio","base","embed","feDisplacementMap","feImage","feTile","filter","font-face-uri","iframe","image","link","object","script","source","track","use","video"],_=["audio","embed","iframe","img","input","script","source","track","video","frame","frameset","object","picture","use"],k=N.concat(_);function u(i){try{i=new URL(i);let e=i.pathname.lastIndexOf(".");if(!e)return null;let t=i.pathname.substring(e+1);return F[t]}catch(e){console.error("Failed to detect media type!",i,e)}}var h=class{constructor(e){if(this.controller=e,this.hosts=e.hostsValue,e.invalidTemplateValue){let t=document.getElementById(e.invalidTemplateValue);t&&(this.invalidTemplate=t)}if(e.validTemplateValue){let t=document.getElementById(e.validTemplateValue);t&&(this.validTemplate=t)}}renderHeader(e,t=""){if(t!=null&&t.length)return`
    <h1 style="background-color:ivory; border:solid 1px red; color:red; padding:5px; display:flex; align-items:center; font-size:1.25rem; line-height:1.5rem;">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="flex:1; width:1rem; height:1rem;">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" />
      </svg>
      ${e}
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="flex:1; width:1rem; height:1rem;">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" />
      </svg>
    </h1>
    `}renderEmbed(e="https://example.com"){let t=this.validTemplate.content.firstElementChild.cloneNode(!0),r=t.querySelector("iframe"),s=t.querySelector("img");return u(e)?(r.remove(),s.src=e):(s.remove(),r.src=e),t.outerHTML}renderLinks(e=["https://example.com","https://test.com"]){return e=e.reduce((r,s)=>(m(s,n=>r.push(n)),r),e||[]),e.length?`<ul>${e.map(r=>`<li><a href='${r}'>${r}</a></li>`).join("")}</ul><br>`:void 0}renderValid(e=["https://example.com","https://test.com"]){if(e!=null&&e.length)return e.map(t=>this.renderEmbed(t))}renderInvalid(e=["https://example.com","https://test.com"]){if(!(e!=null&&e.length))return;let t=this.invalidTemplate.content.firstElementChild.cloneNode(!0),r=t.querySelector('[data-list="allowed-hosts"]'),s=t.querySelector('[data-list="hosts"]');if(r&&(this.hosts.length?r.innerHTML=this.hosts.map(n=>`<li><code>${n}</code></li>`).join(""):r.innerHTML=`
          <li>
            <strong>Allowed hosts not configured yet.</strong>
          </li>
        `),s){let n=R(e);n.length?s.innerHTML=n.map(l=>`<li><code>${l}</code></li>`).join(""):s.innerHTML="<li><code>Media is only supported from allowed hosts.</code></li>"}return t.outerHTML}set validTemplate(e){this._validTemplate=e}get validTemplate(){if(this._validTemplate)return this._validTemplate;let e=document.createElement("template");return e.innerHTML="<div><iframe></iframe><img></img></div>",e}set invalidTemplate(e){this._invalidTemplate=e}get invalidTemplate(){if(this._invalidTemplate)return this._invalidTemplate;let e=document.createElement("template");return e.innerHTML=`
      <div style="background-color:ivory; border:solid 1px red; color:red; padding:15px; font-size:1rem; line-height:1.5rem;">
        <h1 class="display:flex; align-items:center;">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1rem; height:1rem; transform: scale(1.5);">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
          <span style="margin-left:5px; margin-right:5px;">Copy / Paste</span>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1rem; height:1rem; transform: scale(1.5);">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
        </h1>
        <h3 style="font-weight:normal;">The pasted content includes media from unsupported hosts / domains.</h3>

        <h2>Prohibited Hosts / Domains</h2>
        <ul data-list="hosts"></ul>

        <h2 style="color:green;">Allowed Hosts / Domains</h2>
        <ul data-list="allowed-hosts" style="color:green;"></ul>
      </div>
    `,e}};import{Controller as q}from"https://unpkg.com/@hotwired/stimulus@3.2.1/dist/stimulus.js";var p=class extends q{connect(){this.setupWeakSecurity()}paste(i){let{html:e,string:t,range:r}=i.paste,s=e||t||"",n=this.buildPastedTemplate(s),l=n.content.firstElementChild,d=H(l);if(!d.length)return;i.preventDefault(),this.editor.setSelectedRange(r);let a=new h(this),c=d.filter(o=>u(o));Array.from(n.content.firstElementChild.querySelectorAll("iframe")).forEach(o=>{c.includes(o.src)||c.push(o.src)});let g=c.filter(o=>f(o,this.hostsValue)),v=a.renderValid(g),E=c.filter(o=>!g.includes(o)),U=a.renderInvalid(E),T=d.filter(o=>!c.includes(o)),L=T.filter(o=>f(o,this.hostsValue)),S=a.renderValid(L),C=T.filter(o=>!L.includes(o)),w=a.renderLinks(C),y=l.cloneNode(!0);y.querySelectorAll(k.join(", ")).forEach(o=>o.remove());let x=y.innerHTML;this.insert(U,{first:!0}).then(()=>{this.insert(a.renderHeader("Pasted URLs",w)).then(()=>{this.insert(w,{disposition:"inline"}).then(()=>{this.insert(a.renderHeader("Embedded Media",v)).then(()=>{this.insert(v).then(()=>{this.insert(S).then(()=>{this.insert(a.renderHeader("Pasted Content",x)).then(()=>{this.editor.insertLineBreak(),this.insert(x,{disposition:"inline"})})})})})})})})}buildPastedTemplate(i){let e=document.createElement("template");return e.innerHTML=`<div>${i.trim()}</div>`,e}insertAttachment(i,e={delay:0}){let{delay:t}=e;return new Promise(r=>{setTimeout(()=>{let s=new Trix.Attachment({content:i,contentType:"application/vnd.trix-embed.html"});this.editor.insertAttachment(s),r()},t)})}insertHTML(i,e={delay:0}){let{delay:t}=e;return new Promise(r=>{setTimeout(()=>{this.editor.insertHTML(i),this.editor.moveCursorInDirection("forward"),this.editor.insertLineBreak(),this.editor.moveCursorInDirection("backward"),r()},t)})}insert(i,e={delay:0,disposition:"attachment",first:!1}){let{delay:t,disposition:r,first:s}=e;return i!=null&&i.length?new Promise(n=>{setTimeout(()=>{if(s&&this.editor.deleteInDirection("backward"),typeof i=="string")return r==="inline"?this.insertHTML(i,{delay:t}).then(n):this.insertAttachment(i,{delay:t}).then(n);if(Array.isArray(i))return r==="inline"?i.reduce((l,d,a)=>l.then(this.insertHTML(d,{delay:t})),Promise.resolve()).then(n):i.reduce((l,d,a)=>l.then(this.insertAttachment(d,{delay:t})),Promise.resolve()).then(n);n()})}):Promise.resolve()}get editor(){return this.element.editor}setupWeakSecurity(){let i=this.element.closest("[id]"),e=i?i.id:"";this.hostsKey=`trix-embed-hosts-${e}`,this.rememberedHosts&&(this.hostsValue=this.rememberedHosts),this.rememberHosts()}rememberHosts(){sessionStorage.setItem(this.hostsKey,JSON.stringify(this.hostsValue))}get rememberedHosts(){let i=sessionStorage.getItem(this.hostsKey);return i?JSON.parse(i):null}};M(p,"values",{hosts:Array,validTemplate:String,invalidTemplate:String});var z={application:null};function $(i=z){let{application:e}=i;e.register("trix-embed",p)}var re={initialize:$};export{re as default};
//# sourceMappingURL=trix-embed.js.map
