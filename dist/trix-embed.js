var $=Object.defineProperty,z=Object.defineProperties;var F=Object.getOwnPropertyDescriptors;var A=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable;var T=(r,e,t)=>e in r?$(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,C=(r,e)=>{for(var t in e||(e={}))O.call(e,t)&&T(r,t,e[t]);if(A)for(var t of A(e))_.call(e,t)&&T(r,t,e[t]);return r},R=(r,e)=>z(r,F(e));var U=(r,e,t)=>(T(r,typeof e!="symbol"?e+"":e,t),t);var E={name:"AES-GCM",length:256},B=!0,q=["encrypt","decrypt"];async function D(){let e=["encrypt","decrypt"];return await crypto.subtle.generateKey(E,!0,e)}async function J(r){let e=await crypto.subtle.exportKey("jwk",r);return JSON.stringify(e)}async function W(r){let e=JSON.parse(r);return await crypto.subtle.importKey("jwk",e,E,B,q)}async function G(r,e){let t=new TextEncoder().encode(String(r)),i=crypto.getRandomValues(new Uint8Array(12)),n=await crypto.subtle.encrypt(R(C({},E),{iv:i}),e,t),o={ciphertext:btoa(String.fromCharCode(...new Uint8Array(n))),iv:btoa(String.fromCharCode(...i))};return btoa(JSON.stringify(o))}async function L(){let r=await D(),e=await J(r);return btoa(e)}async function k(r,e=[]){let t=await W(atob(r));return Promise.all(e.map(i=>G(i,t)))}async function H(r=[]){let e=await L(),t=await k(e,r);return console.log(`data-trix-embed-key-value="${e}"`),console.log(`data-trix-embed-hosts-value='${JSON.stringify(t)}'`),{key:e,encryptedValues:t}}function p(r,e=t=>{}){try{let t=new URL(String(r).trim());return e&&e(t),t}catch(t){console.info(`Failed to parse URL! value='${r}']`)}return null}function j(r,e=t=>{}){let t=null;return p(r,i=>t=i.host),t&&e&&e(t),t}function X(r){let e=[],t=document.createTreeWalker(r,NodeFilter.SHOW_TEXT,n=>n.nodeValue.includes("http")?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT),i;for(;i=t.nextNode();)i.nodeValue.split(/\s+/).filter(n=>n.startsWith("http")).forEach(n=>p(n,o=>{e.includes(o.href)||e.push(o.href)}));return e}function Q(r){let e=[];return r.src&&p(r.src,i=>e.push(i.href)),r.href&&p(r.href,i=>{e.includes(i.href)||e.push(i.href)}),r.querySelectorAll("[src], [href]").forEach(i=>{p(i.src||i.href,n=>{e.includes(n.href)||e.push(n.href)})}),e}function M(r,e=[]){let t=!1;return j(r,i=>t=!!e.find(n=>i.includes(n))),t}function V(r){return r.reduce((e,t)=>(j(t,i=>{e.includes(i)||e.push(i)}),e),[])}function N(r){let e=Q(r),t=X(r);return[...new Set([...e,...t])]}var Y={avif:"image/avif",bmp:"image/bmp",gif:"image/gif",heic:"image/heic",heif:"image/heif",ico:"image/x-icon",jp2:"image/jp2",jpeg:"image/jpeg",jpg:"image/jpeg",jxr:"image/vnd.ms-photo",png:"image/png",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",webp:"image/webp"};var Z=Y,ee=["animate","animateMotion","animateTransform","area","audio","base","embed","feDisplacementMap","feImage","feTile","filter","font-face-uri","iframe","image","link","object","script","source","track","use","video"],te=["audio","embed","iframe","img","input","script","source","track","video","frame","frameset","object","picture","use"],P=ee.concat(te);function x(r){try{r=new URL(r);let e=r.pathname.lastIndexOf(".");if(!e)return null;let t=r.pathname.substring(e+1);return Z[t]}catch(e){console.error("Failed to detect media type!",r,e)}}var f=class{constructor(e){this.controller=e}protect(){if(!this.controller.formElement)return;let e=this.controller.formElement,t=this.controller.inputElement;new MutationObserver((n,o)=>{n.forEach(l=>{var m;let{addedNodes:w,target:d,type:h}=l;switch(h){case"attributes":((m=d.closest("form"))==null?void 0:m.action)===e.action&&(d.id===t.id||d.name===t.name)&&d.remove();break;case"childList":w.forEach(a=>{var u;a.nodeType===Node.ELEMENT_NODE&&(a.tagName.match(/^form$/i)&&a.action===e.action&&a.remove(),((u=d.closest("form"))==null?void 0:u.action)===e.action&&(a.id===t.id||a.name===t.name)&&a.remove())});break}})}).observe(document.body,{attributeFilter:["id","name"],attributes:!0,childList:!0,subtree:!0})}cleanup(){let e=this.controller.element,t=this.controller.inputElement,i=this.controller.toolbarElement;t==null||t.remove(),i==null||i.remove(),e==null||e.remove()}};var g=class{constructor(e){var t;this.controller=e,this.base=[...[location.pathname,(t=this.controller.element.closest("[id]"))==null?void 0:t.id].join("/")].map(i=>i.charCodeAt(0)).reverse().join("")}read(e){return sessionStorage.getItem(this.generateStorageKey(e))}write(e,t){return sessionStorage.setItem(this.generateStorageKey(e),t)}remove(e){return sessionStorage.removeItem(this.generateStorageKey(e))}generateStorageKey(e){let t=[...e].map(l=>l.charCodeAt(0)),i=Math.ceil(t.length/2),n=t.slice(0,i).join(""),o=t.slice(i).join("");return btoa(`${n}/${this.base}/${o}`)}};var y=class{constructor(e){if(this.controller=e,this.hosts=this.controller.hostsValue,this.controller.invalidTemplateValue){let t=document.getElementById(this.controller.invalidTemplateValue);t&&(this.invalidTemplate=t)}if(this.controller.validTemplateValue){let t=document.getElementById(this.controller.validTemplateValue);t&&(this.validTemplate=t)}}renderHeader(e){return`
    <h1 style="background-color:ivory; border:solid 1px red; color:red; padding:5px; display:flex; align-items:center; font-size:1.25rem; line-height:1.5rem;">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="flex:1; width:1rem; height:1rem;">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" />
      </svg>
      ${e}
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="flex:1; width:1rem; height:1rem;">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" />
      </svg>
    </h1>
    `}renderEmbed(e="https://example.com"){let t=this.validTemplate.content.firstElementChild.cloneNode(!0),i=t.querySelector("iframe"),n=t.querySelector("img");return x(e)?(i.remove(),n.src=e):(n.remove(),i.src=e),t.outerHTML}renderLinks(e=["https://example.com","https://test.com"]){return e=e.filter(i=>{let n=!1;return p(i,o=>n=!0),n}).sort(),e.length?`<ul>${e.map(i=>`<li><a href='${i}'>${i}</a></li>`).join("")}</ul><br>`:void 0}renderValid(e=["https://example.com","https://test.com"]){if(e!=null&&e.length)return e.map(t=>this.renderEmbed(t))}renderInvalid(e=["https://example.com","https://test.com"]){if(!(e!=null&&e.length))return;let t=this.invalidTemplate.content.firstElementChild.cloneNode(!0),i=t.querySelector('[data-list="allowed-hosts"]'),n=t.querySelector('[data-list="hosts"]');if(i&&(this.hosts.length?i.innerHTML=this.hosts.map(o=>`<li><code>${o}</code></li>`).join(""):i.innerHTML=`
          <li>
            <strong>Allowed hosts not configured yet.</strong>
          </li>
        `),n){let o=V(e);o.length?n.innerHTML=o.map(l=>`<li><code>${l}</code></li>`).join(""):n.innerHTML="<li><code>Media is only supported from allowed hosts.</code></li>"}return t.outerHTML}set validTemplate(e){this._validTemplate=e}get validTemplate(){if(this._validTemplate)return this._validTemplate;let e=document.createElement("template");return e.innerHTML="<div><iframe></iframe><img></img></div>",e}set invalidTemplate(e){this._invalidTemplate=e}get invalidTemplate(){if(this._invalidTemplate)return this._invalidTemplate;let e=document.createElement("template");return e.innerHTML=`
      <div style="background-color:ivory; border:solid 1px red; color:red; padding:15px; font-size:1rem; line-height:1.5rem;">
        <h1 style="display:flex; align-items:center;">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="flex:1; width:1rem; height:1rem; transform: scale(1.5);">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
          Copy / Paste
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="flex:1; width:1rem; height:1rem; transform: scale(1.5);">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
        </h1>

        <h3 style="padding:15px; font-weight:normal; border-top:solid 1px red; border-bottom:solid 1px red;">The pasted content includes media from unsupported hosts / domains.</h3>

        <h2>Prohibited Hosts / Domains</h2>
        <ul data-list="hosts"></ul>

        <h2 style="color:green;">Allowed Hosts / Domains</h2>
        <ul data-list="allowed-hosts" style="color:green;"></ul>
      </div>
    `,e}};import{Controller as re}from"https://unpkg.com/@hotwired/stimulus@3.2.1/dist/stimulus.js";var v=class extends re{connect(){this.store=new g(this),this.guard=new f(this),this.rememberConfig(),this.paranoid&&this.guard.protect()}disconnect(){this.paranoid&&this.guard.cleanup(),this.forgetConfig()}async paste(r){let{html:e,string:t,range:i}=r.paste,n=e||t||"",o=this.buildPastedTemplate(n),l=o.content.firstElementChild,d=this.sanitizePastedElement(l).innerHTML.trim(),h=N(l);if(!h.length)return;r.preventDefault(),this.editor.setSelectedRange(i);let m=new y(this),a=h.filter(s=>x(s));Array.from(o.content.firstElementChild.querySelectorAll("iframe")).forEach(s=>{a.includes(s.src)||a.push(s.src)});let u=a.filter(s=>M(s,this.hostsValue)),K=a.filter(s=>!u.includes(s)),S=h.filter(s=>!a.includes(s)),b=S.filter(s=>M(s,this.hostsValue)),I=S.filter(s=>!b.includes(s)),c;c=K,c.length&&await this.insert(m.renderInvalid(c)),c=I,c.length&&(await this.insert(m.renderHeader("Pasted URLs")),await this.insert(m.renderLinks(c),{disposition:"inline"})),c=u,c.length&&(c.length>1&&await this.insert(m.renderHeader("Embedded Media")),await this.insert(m.renderValid(c))),c=b,c.length&&await this.insert(m.renderValid(b)),!(h.length===1||u[0]===d)&&(h.length===1||b[0]===d||d.length&&(await this.insert(m.renderHeader("Pasted Content",d)),this.editor.insertLineBreak(),this.insert(d,{disposition:"inline"})))}buildPastedTemplate(r){let e=document.createElement("template");return e.innerHTML=`<div>${r.trim()}</div>`,e}sanitizePastedElement(r){return r=r.cloneNode(!0),r.querySelectorAll(P.join(", ")).forEach(e=>e.remove()),r}insertAttachment(r,e={delay:0}){let{delay:t}=e;return new Promise(i=>{setTimeout(()=>{let n=new Trix.Attachment({content:r,contentType:"application/vnd.trix-embed.html"});this.editor.insertAttachment(n),i()},t)})}insertHTML(r,e={delay:0}){let{delay:t}=e;return new Promise(i=>{setTimeout(()=>{this.editor.insertHTML(r),this.editor.moveCursorInDirection("forward"),this.editor.insertLineBreak(),this.editor.moveCursorInDirection("backward"),i()},t)})}insert(r,e={delay:0,disposition:"attachment"}){let{delay:t,disposition:i}=e;return r!=null&&r.length?new Promise(n=>{setTimeout(()=>{if(typeof r=="string")return i==="inline"?this.insertHTML(r,{delay:t}).then(n):this.insertAttachment(r,{delay:t}).then(n);if(Array.isArray(r))return i==="inline"?r.reduce((o,l,w)=>o.then(this.insertHTML(l,{delay:t})),Promise.resolve()).then(n):r.reduce((o,l,w)=>o.then(this.insertAttachment(l,{delay:t})),Promise.resolve()).then(n);n()})}):Promise.resolve()}get editor(){return this.element.editor}get toolbarElement(){let r=this.element.previousElementSibling;return r!=null&&r.tagName.match(/trix-toolbar/i)?r:null}get inputElement(){return document.getElementById(this.element.getAttribute("input"))}get formElement(){return this.element.closest("form")}get paranoid(){return this.store.read("paranoid")==="true"}get key(){return this.store.read("key")}get list(){try{return JSON.parse(this.store.read("list"))}catch(r){return[]}}rememberConfig(){this.store.write("key",this.keyValue),this.element.removeAttribute("data-trix-embed-key-value"),this.store.write("list",JSON.stringify(this.listValue)),this.element.removeAttribute("data-trix-embed-list-value"),this.store.write("paranoid",this.paranoidValue),this.element.removeAttribute("data-trix-embed-paranoid")}forgetConfig(){this.store.remove("key"),this.store.remove("list"),this.store.remove("paranoid")}};U(v,"values",{hosts:Array,validTemplate:String,invalidTemplate:String,key:String,list:Array,paranoid:Boolean});var ie={application:null};function ne(r=ie){let{application:e}=r;e.register("trix-embed",v)}self.TrixEmbed={initialize:ne,generateKey:L,encryptValues:k,generateKeyAndEncryptValues:H};var Me=self.TrixEmbed;export{Me as default};
